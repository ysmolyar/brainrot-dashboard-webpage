<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brainrot Dashboard</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="brainrot-icon.png">
  <link rel="apple-touch-icon" href="brainrot-icon.png">

  <!-- Meta tags for better SEO and sharing -->
  <meta name="description" content="Real-time analytics dashboard for Brainrot app - track revenue, conversions, and ad spend">
  <meta name="author" content="Brainrot">
  <meta name="theme-color" content="#111827">

  <!-- Open Graph tags for social sharing -->
  <meta property="og:title" content="Brainrot Dashboard">
  <meta property="og:description" content="Real-time analytics dashboard for Brainrot app">
  <meta property="og:image" content="brainrot-icon.png">
  <meta property="og:type" content="website">

  <!-- Apple specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Brainrot">

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111827;
      color: white;
      padding: 16px;
      min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; width: 100%; }

    /* Mobile-specific adjustments */
    @media (max-width: 600px) {
      body { padding: 8px; }
      .container { padding: 0; }
    }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .main-header { position: relative; }
    .header-icon { position: absolute; left: 0; top: 50%; transform: translateY(-50%); }
    .header-title { position: absolute; left: 50%; transform: translateX(-50%); text-align: center; }
    .main-header .controls { margin-left: auto; }
    h1 { font-size: 1.5rem; }
    .updated { font-size: 0.75rem; color: #6B7280; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    @media (max-width: 600px) {
      header { gap: 8px; margin-bottom: 12px; }
      .main-header { min-height: 50px; padding-top: 8px; }
      .header-icon { position: absolute; left: 0; top: 8px; transform: none; }
      .header-title { position: absolute; left: 50%; top: 8px; transform: translateX(-50%); }
      .hamburger-menu { top: 8px; }
      h1 { font-size: 1.25rem; }
      button, select {
        padding: 6px 10px;
        font-size: 16px; /* 16px prevents iOS zoom on form controls */
      }
    }
    button, select {
      background: #374151;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      -webkit-text-size-adjust: 100%; /* Prevent text size adjustment */
    }
    button:hover, select:hover { background: #4B5563; }
    button.active { background: #2563EB; }
    select {
      padding-right: 28px;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg width='8' height='5' viewBox='0 0 8 5' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M1 1L4 4L7 1' stroke='%239CA3AF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }
    .cards { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 16px; }
    @media (max-width: 900px) { .cards { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 600px) { .cards { grid-template-columns: repeat(2, 1fr); } }
    .card {
      background: #1F2937;
      padding: 12px;
      border-radius: 8px;
    }
    .card-label { font-size: 0.75rem; color: #9CA3AF; }
    .card-value { font-size: 1.5rem; font-weight: bold; }

    @media (max-width: 600px) {
      .card { padding: 8px; }
      .card-value { font-size: 1.25rem; }
      .card-label { font-size: 0.7rem; }
    }
    .red { color: #F87171; }
    .green { color: #4ADE80; }
    .cyan { color: #22D3D3; }
    .blue { color: #60A5FA; }
    .chart-container {
      background: #1F2937;
      padding: 40px 16px 16px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .chart-container {
        padding: 20px 8px 8px 8px;
        border-radius: 4px;
      }
      .chart-wrapper { height: 250px; }
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chart-title { font-size: 0.875rem; color: #9CA3AF; }
    .toggles { display: flex; gap: 12px; flex-wrap: wrap; }
    .toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .toggle input { display: none; }
    .toggle-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 2px solid;
    }
    .toggle input:checked + .toggle-box { background: currentColor; }
    .toggle-new { color: #4ADE80; }
    .toggle-renewal { color: #22D3D3; }
    .toggle-spend { color: #F87171; }
    .chart-wrapper { position: relative; height: 350px; }
    table { font-size: 0.8rem; border-collapse: collapse; white-space: nowrap; }
    th { text-align: left; color: #6B7280; padding: 6px 10px; min-width: 100px; font-weight: 500; background: transparent; }
    th:first-child { min-width: 160px; }
    th:last-child { font-weight: 600; }
    td { padding: 6px 10px; text-align: left; min-width: 100px; background: transparent; }
    td:first-child { font-weight: 500; min-width: 160px; }

    /* Mobile table adjustments */
    @media (max-width: 600px) {
      th { min-width: 60px; padding: 4px 6px; font-size: 0.75rem; }
      th:first-child { min-width: 100px; }
      td { min-width: 60px; padding: 4px 6px; font-size: 0.75rem; }
      td:first-child { min-width: 100px; }
    }
    td:last-child { font-weight: 600; }
    tr { border-bottom: 1px solid #2D3748; }
    tr:last-child { border-bottom: none; }
    .mono { font-family: 'SF Mono', monospace; }
    #data-table { min-width: 100%; }

    /* Sticky column styles */
    .sticky-col {
      position: sticky;
      left: -20px;
      background: #1A202C !important;
      z-index: 2;
      padding-left: 40px;
      padding-right: 20px;
      box-shadow: 2px 0 4px rgba(0,0,0,0.3);
      min-width: 160px;
    }

    th.sticky-col,
    td.sticky-col {
      background: #1A202C !important;
    }

    @media (max-width: 600px) {
      .sticky-col {
        min-width: 120px;
        padding-left: 28px;
        padding-right: 8px;
        left: -20px;
      }
      #transactions-table {
        zoom: 0.7;
      }
    }

    /* Hamburger menu styles */
    .hamburger-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 0;
    }
    .hamburger-btn {
      background: transparent;
      border: none;
      color: white;
      padding: 8px;
      cursor: pointer;
    }
    .hamburger-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: #1F2937;
      border: 1px solid #374151;
      border-radius: 8px;
      min-width: 180px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
      overflow: hidden;
    }
    .hamburger-dropdown.open {
      display: block;
    }
    .menu-section {
      border-bottom: 1px solid #374151;
      padding: 8px 0;
    }
    .menu-section:last-child {
      border-bottom: none;
    }
    .menu-label {
      color: #6B7280;
      font-size: 0.7rem;
      padding: 4px 16px;
      text-transform: uppercase;
    }
    .menu-option {
      color: white;
      font-size: 0.85rem;
      padding: 10px 16px;
      cursor: pointer;
    }
    .menu-option:hover {
      background: #374151;
    }
    .menu-option.active {
      background: #2563EB;
    }
    @media (max-width: 600px) {
      .hamburger-menu {
        display: block;
      }
      .desktop-controls {
        display: none !important;
      }
    }

    /* Dropdown hover styles */
    .granularity-dropdown div[onclick]:hover {
      background: #374151 !important;
    }

    /* Checkbox toggle styles */
    input[type="checkbox"]:not(:checked) + label {
      background: transparent !important;
      border: 2px solid;
    }
    input#toggle-new:not(:checked) + label {
      border-color: #4ADE80;
    }
    input#toggle-renewal:not(:checked) + label {
      border-color: #22D3D3;
    }
    input#toggle-spend:not(:checked) + label {
      border-color: #EF4444;
    }

    /* Dark scrollbar styles */
    ::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1A202C;
    }
    ::-webkit-scrollbar-thumb {
      background: #4A5568;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }

    /* Password gate styles */
    .password-gate {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #111827;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .password-gate.hidden {
      display: none;
    }
    .password-form {
      background: #1F2937;
      padding: 32px;
      border-radius: 12px;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }
    .password-form img {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      margin-bottom: 16px;
    }
    .password-form h2 {
      color: white;
      font-size: 1.25rem;
      margin-bottom: 8px;
    }
    .password-form p {
      color: #6B7280;
      font-size: 0.875rem;
      margin-bottom: 24px;
    }
    .password-form input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      background: #374151;
      border: 1px solid #4B5563;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      margin-bottom: 16px;
      box-sizing: border-box;
    }
    .password-form input[type="password"]:focus {
      outline: none;
      border-color: #60A5FA;
    }
    .password-form button {
      width: 100%;
      padding: 12px 16px;
      background: #2563EB;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    .password-form button:hover {
      background: #1D4ED8;
    }
    .password-error {
      color: #F87171;
      font-size: 0.875rem;
      margin-top: 12px;
      display: none;
    }
    .dashboard-content {
      display: none;
    }
    .dashboard-content.visible {
      display: block;
    }
    /* Pull to refresh styles */
    .ptr-wrapper {
      position: relative;
      overflow: visible;
    }
    .ptr-spinner {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 24px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .ptr-spinner.visible {
      opacity: 1;
    }
    .ptr-spinner svg {
      width: 24px;
      height: 24px;
      color: #6B7280;
    }
    .ptr-spinner.refreshing svg {
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Pull to refresh spinner -->
  <div id="ptr-spinner" class="ptr-spinner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
    </svg>
  </div>

  <!-- Password Gate -->
  <div id="password-gate" class="password-gate">
    <div class="password-form">
      <img src="brainrot-icon.png" alt="Brainrot">
      <h2>Brainrot Dashboard</h2>
      <p>Enter password to continue</p>
      <form onsubmit="return checkPassword(event)">
        <input type="password" id="password-input" placeholder="Password" autocomplete="current-password">
        <button type="submit">Enter</button>
      </form>
      <div id="password-error" class="password-error">Incorrect password</div>
    </div>
  </div>

  <div class="container dashboard-content" id="dashboard-content">
    <header class="main-header">
      <img src="brainrot-icon.png" alt="Brainrot" class="header-icon" style="width: 32px; height: 32px; border-radius: 8px; object-fit: cover;">
      <div class="header-title">
        <h1>Brainrot</h1>
        <div class="updated" id="updated"></div>
      </div>
      <!-- Hamburger menu for mobile -->
      <div class="hamburger-menu">
        <button class="hamburger-btn" onclick="toggleHamburgerMenu()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div id="hamburger-dropdown" class="hamburger-dropdown">
          <div class="menu-section">
            <div class="menu-label">Time Range</div>
            <div class="menu-option" onclick="selectTimeRange('24h')">Last 24 Hours</div>
            <div class="menu-option" onclick="selectTimeRange('today')">Today</div>
            <div class="menu-option" onclick="selectTimeRange('yesterday')">Yesterday</div>
            <div class="menu-option" onclick="selectTimeRange('7d')">Last 7 Days</div>
            <div class="menu-option" onclick="selectTimeRange('14d')">Last 14 Days</div>
            <div class="menu-option" onclick="selectTimeRange('30d')">Last 30 Days</div>
            <div class="menu-option" onclick="selectTimeRange('90d')">Last 90 Days</div>
            <div class="menu-option" onclick="selectTimeRange('180d')">Last 180 Days</div>
          </div>
          <div class="menu-section">
            <div class="menu-label">Timezone</div>
            <div class="menu-option" onclick="selectTimezone('America/Los_Angeles')">PST</div>
            <div class="menu-option" onclick="selectTimezone('America/New_York')">EST</div>
          </div>
          <div class="menu-section">
            <div class="menu-option" onclick="fetchData(true); toggleHamburgerMenu();">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Refresh
            </div>
          </div>
        </div>
      </div>
      <!-- Desktop controls -->
      <div class="controls desktop-controls">
        <select id="time-range" onchange="handleTimeRangeChange()">
          <option value="24h" selected>Last 24 Hours</option>
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="7d">Last 7 Days</option>
          <option value="14d">Last 14 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="90d">Last 90 Days</option>
          <option value="180d">Last 180 Days</option>
        </select>
        <select id="timezone" onchange="render()">
          <option value="America/Los_Angeles">PST</option>
          <option value="America/New_York">EST</option>
        </select>
        <button onclick="fetchData(true)" style="padding: 6px 10px; display: flex; align-items: center; justify-content: center;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 4v6h-6"></path>
            <path d="M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
      </div>
    </header>

    <div class="cards">
      <div class="card">
        <div class="card-value" id="total-proceeds" style="color: white;">$0</div>
        <div class="card-label">Total Proceeds</div>
      </div>
      <div class="card">
        <div class="card-value" id="total-spend" style="color: white;">$0</div>
        <div class="card-label">Ad Spend</div>
      </div>
      <div class="card">
        <div class="card-value" id="total-conversions" style="color: white;">0</div>
        <div class="card-label">Total Conv's</div>
      </div>
      <div class="card">
        <div class="card-value" id="initial-conversions" style="color: white;">0</div>
        <div class="card-label">Initial Conv's</div>
      </div>
      <div class="card">
        <div class="card-value" id="net-profit" style="color: white;">$0</div>
        <div class="card-label">Net Profit</div>
      </div>
      <div class="card">
        <div class="card-value" id="roas" style="color: white;">0.00</div>
        <div class="card-label">ROAS</div>
      </div>
    </div>

    <div class="chart-container" style="position: relative; padding-top: 40px;">
      <div style="position: absolute; top: 12px; right: 16px; z-index: 10;">
        <div class="granularity-dropdown">
          <button id="granularity-toggle" onclick="toggleGranularityDropdown()" style="background: transparent; border: none; color: white; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 8px; font-weight: 500;">
            <span id="granularity-label">Hourly</span>
            <svg width="8" height="5" viewBox="0 0 8 5" fill="none" style="margin-top: 1px;">
              <path d="M1 1L4 4L7 1" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div id="granularity-menu" style="display: none; position: absolute; top: 100%; right: 0; background: #1F2937; border: 1px solid #374151; border-radius: 4px; margin-top: 4px; min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            <div onclick="selectGranularity('hourly')" style="padding: 8px 12px; cursor: pointer; color: white; font-size: 0.75rem;">Hourly</div>
            <div onclick="selectGranularity('daily')" style="padding: 8px 12px; cursor: pointer; color: white; font-size: 0.75rem; border-top: 1px solid #374151;">Daily</div>
          </div>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="chart-container" style="overflow-x: auto; background: #1A202C; padding: 20px;">
      <table id="data-table">
        <thead>
          <tr id="table-header" style="border-bottom: 1px solid #2D3748;">
            <th class="sticky-col">
              <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="color: #9CA3AF; font-size: 0.9rem;">$</span>
                  <span style="color: white; font-size: 1rem; font-weight: 500;">Proceeds</span>
                </div>
                <span style="color: #6B7280; font-size: 0.75rem; font-weight: 400;">Renewal Type</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr id="new-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="toggle-new" checked onchange="updateChart()" style="display: none;">
                <label for="toggle-new" style="display: inline-block; width: 12px; height: 12px; background: #4ADE80; border-radius: 2px; cursor: pointer;"></label>
                <span>New</span>
              </div>
            </td>
          </tr>
          <tr id="renewal-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="toggle-renewal" checked onchange="updateChart()" style="display: none;">
                <label for="toggle-renewal" style="display: inline-block; width: 12px; height: 12px; background: #22D3D3; border-radius: 2px; cursor: pointer;"></label>
                <span>Renewal</span>
              </div>
            </td>
          </tr>
          <tr id="spend-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="toggle-spend" checked onchange="updateChart()" style="display: none;">
                <label for="toggle-spend" style="display: inline-block; width: 12px; height: 12px; background: #EF4444; border-radius: 2px; cursor: pointer;"></label>
                <span>Spend</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Recent Transactions Section -->
    <div class="chart-container" style="background: #1A202C; padding: 24px; margin-top: 16px;">
      <div style="margin-bottom: 20px;">
        <h2 style="font-size: 1rem; color: white; font-weight: 500;">Recent Transactions</h2>
      </div>
      <div class="transactions-wrapper" style="overflow-x: auto;">
        <table id="transactions-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #374151;">User</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #374151;">Product</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #374151;">Proceeds</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #374151;">When</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #374151;">Type</th>
            </tr>
          </thead>
          <tbody id="transactions-tbody">
            <!-- Transactions will be inserted here -->
          </tbody>
        </table>
      </div>
      <div id="show-more-container" style="margin-top: 16px; display: none;">
        <button id="show-more-btn" onclick="toggleShowMore()" style="background: transparent; border: none; color: #60A5FA; cursor: pointer; font-size: 0.8125rem; padding: 8px 0; display: flex; align-items: center; gap: 6px;">
          <span id="more-text">Show 34 more</span>
          <span style="font-size: 0.75rem;">↓</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://tuueizexidbuvvgvxpms.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1dWVpemV4aWRidXZ2Z3Z4cG1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjM2NjksImV4cCI6MjA4MTM5OTY2OX0.lQ0MVBF98Jvc8qzP4M3W2osRvWQlUuCHeVTajuERi7A';

    let granularity = 'hourly';
    let chart = null;
    let adsData = [];
    let revenueData = [];
    let processedData = [];
    let showAllTransactions = false;

    async function fetchData(forceRefresh = false) {
      const CACHE_KEY = 'brainrot_dashboard_cache';
      const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache

      // Check cache first
      if (!forceRefresh) {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
          const cacheData = JSON.parse(cached);
          const cacheAge = Date.now() - cacheData.timestamp;

          if (cacheAge < CACHE_DURATION) {
            // Use cached data
            adsData = cacheData.adsData;
            revenueData = cacheData.revenueData;

            const cacheAgeSeconds = Math.floor(cacheAge / 1000);
            updateSubtitle();
            render();
            return;
          }
        }
      }

      const headers = {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      };

      try {
        // Fetch ads data
        const adsRes = await fetch(`${SUPABASE_URL}/rest/v1/meta_ads_hourly?select=hour_utc,spend&order=hour_utc.asc`, { headers });
        adsData = await adsRes.json();

        // Fetch revenue data with pagination (Supabase limits to 1000 per request)
        const fetchAllRevenue = async () => {
          let allData = [];
          let offset = 0;
          const limit = 1000;

          while (true) {
            const res = await fetch(
              `${SUPABASE_URL}/rest/v1/superwall_events?select=created_at,proceeds,event_type,user_id,product_id,is_refund,raw_payload&order=created_at.asc&limit=${limit}&offset=${offset}`,
              { headers }
            );
            const data = await res.json();
            allData = allData.concat(data);

            if (data.length < limit) break; // No more data
            offset += limit;
          }
          return allData;
        };

        revenueData = await fetchAllRevenue();

        console.log('Ads data rows fetched:', adsData.length);
        console.log('Revenue data rows fetched:', revenueData.length);

        // Save to cache
        const cacheData = {
          timestamp: Date.now(),
          adsData: adsData,
          revenueData: revenueData
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));

        updateSubtitle();
        render();
      } catch (err) {
        alert('Error fetching data: ' + err.message);
      }
    }

    function updateSubtitle() {
      const range = document.getElementById('time-range').value;
      const labels = {
        '24h': 'Last 24 Hours',
        'today': 'Today',
        'yesterday': 'Yesterday',
        '7d': 'Last 7 Days',
        '14d': 'Last 14 Days',
        '30d': 'Last 30 Days',
        '90d': 'Last 90 Days',
        '180d': 'Last 180 Days'
      };
      document.getElementById('updated').textContent = labels[range] || range;
    }

    function toggleGranularityDropdown() {
      const menu = document.getElementById('granularity-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function selectGranularity(g) {
      granularity = g;
      document.getElementById('granularity-label').textContent = g === 'hourly' ? 'Hourly' : 'Daily';
      document.getElementById('granularity-menu').style.display = 'none';
      render();
    }

    function toggleHamburgerMenu() {
      const dropdown = document.getElementById('hamburger-dropdown');
      dropdown.classList.toggle('open');
    }

    function selectTimeRange(value) {
      document.getElementById('time-range').value = value;
      updateHamburgerMenuSelection();
      handleTimeRangeChange();
      toggleHamburgerMenu();
    }

    function selectTimezone(value) {
      document.getElementById('timezone').value = value;
      updateHamburgerMenuSelection();
      render();
      toggleHamburgerMenu();
    }

    function updateHamburgerMenuSelection() {
      const timeRange = document.getElementById('time-range').value;
      const timezone = document.getElementById('timezone').value;

      // Update time range options
      document.querySelectorAll('.menu-section:first-child .menu-option').forEach(opt => {
        const optValue = opt.getAttribute('onclick').match(/'([^']+)'/)[1];
        opt.classList.toggle('active', optValue === timeRange);
      });

      // Update timezone options
      document.querySelectorAll('.menu-section:nth-child(2) .menu-option').forEach(opt => {
        const optValue = opt.getAttribute('onclick').match(/'([^']+)'/)[1];
        opt.classList.toggle('active', optValue === timezone);
      });
    }

    // Close hamburger menu when clicking outside
    document.addEventListener('click', function(e) {
      const menu = document.querySelector('.hamburger-menu');
      const dropdown = document.getElementById('hamburger-dropdown');
      if (menu && !menu.contains(e.target) && dropdown.classList.contains('open')) {
        dropdown.classList.remove('open');
      }
    });

    function handleTimeRangeChange() {
      const range = document.getElementById('time-range').value;

      // Auto-switch granularity based on time range
      // For 7 days or more, default to daily
      // For 24h, today, yesterday, default to hourly
      if (range === '7d' || range === '14d' || range === '30d' || range === '90d' || range === '180d') {
        if (granularity === 'hourly') {
          selectGranularity('daily');
        }
      } else if (range === '24h' || range === 'today' || range === 'yesterday') {
        if (granularity === 'daily') {
          selectGranularity('hourly');
        }
      }

      updateSubtitle();
      render();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.querySelector('.granularity-dropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        document.getElementById('granularity-menu').style.display = 'none';
      }
    });

    function getTimeRange() {
      const range = document.getElementById('time-range').value;
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      switch (range) {
        case '24h':
          // Start at the beginning of the hour 24 hours ago to capture all data in that hour
          const start24h = new Date(now - 24 * 60 * 60 * 1000);
          start24h.setMinutes(0, 0, 0);
          return { start: start24h, end: now };
        case 'today':
          return { start: today, end: now };
        case 'yesterday':
          const yesterday = new Date(today - 24 * 60 * 60 * 1000);
          return { start: yesterday, end: today };
        case '7d':
          // Today + 6 previous whole days = 7 days total
          return { start: new Date(today - 6 * 24 * 60 * 60 * 1000), end: now };
        case '14d':
          return { start: new Date(today - 13 * 24 * 60 * 60 * 1000), end: now };
        case '30d':
          return { start: new Date(today - 29 * 24 * 60 * 60 * 1000), end: now };
        case '90d':
          return { start: new Date(today - 89 * 24 * 60 * 60 * 1000), end: now };
        case '180d':
          return { start: new Date(today - 179 * 24 * 60 * 60 * 1000), end: now };
        default:
          return { start: new Date(today - 6 * 24 * 60 * 60 * 1000), end: now };
      }
    }

    function render() {
      const { start, end } = getTimeRange();
      
      const bucketKey = (ts) => {
        if (!ts) return null;
        const date = new Date(ts);
        if (date < start || date > end) return null;

        // The data is stored in UTC but needs to be shifted back 8 hours
        // to correct for the timezone issue
        const correctedDate = new Date(date.getTime() - 8 * 60 * 60 * 1000);
        const correctedTs = correctedDate.toISOString();

        if (granularity === 'daily') {
          return correctedTs.slice(0, 10);
        } else {
          return correctedTs.slice(0, 13);
        }
      };

      const map = new Map();

      // Aggregate ad spend
      (adsData || []).forEach(row => {
        const key = bucketKey(row.hour_utc);
        if (key) {
          const existing = map.get(key) || { bucket: key, spend: 0, newPurchases: 0, renewals: 0 };
          existing.spend += parseFloat(row.spend) || 0;
          map.set(key, existing);
        }
      });

      // Aggregate revenue by type
      (revenueData || []).forEach(row => {
        const key = bucketKey(row.created_at);
        if (key) {
          const existing = map.get(key) || { bucket: key, spend: 0, newPurchases: 0, renewals: 0 };
          const proceeds = parseFloat(row.proceeds) || 0;

          if (row.event_type === 'renewal') {
            existing.renewals += proceeds;
          } else {
            existing.newPurchases += proceeds;
          }
          map.set(key, existing);
        }
      });

      processedData = Array.from(map.values())
        .map(d => ({
          ...d,
          totalRevenue: d.newPurchases + d.renewals,
          profit: d.newPurchases + d.renewals - d.spend,
        }))
        .sort((a, b) => a.bucket.localeCompare(b.bucket));

      // Update totals
      const totals = processedData.reduce((acc, d) => ({
        spend: acc.spend + d.spend,
        newPurchases: acc.newPurchases + d.newPurchases,
        renewals: acc.renewals + d.renewals,
      }), { spend: 0, newPurchases: 0, renewals: 0 });

      // Count conversions from Superwall revenue data
      const filteredRevenue = (revenueData || []).filter(row => {
        const key = bucketKey(row.created_at);
        return key;
      });

      const totalConversions = filteredRevenue.length;
      const initialConversions = filteredRevenue.filter(row => row.event_type === 'initial_purchase').length;

      totals.proceeds = totals.newPurchases + totals.renewals;
      totals.profit = totals.proceeds - totals.spend;

      // Calculate ROAS (Return on Ad Spend) - based on new purchases only
      const roas = totals.spend > 0 ? totals.newPurchases / totals.spend : 0;

      document.getElementById('total-proceeds').textContent = '$' + totals.proceeds.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('total-conversions').textContent = totalConversions.toLocaleString('en-US');
      document.getElementById('initial-conversions').textContent = initialConversions.toLocaleString('en-US');
      document.getElementById('total-spend').textContent = '$' + totals.spend.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('roas').textContent = roas.toFixed(2);
      document.getElementById('net-profit').textContent = '$' + totals.profit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      updateChart();
      updateTable();
      updateTransactions();
    }

    function formatLabel(bucket) {
      const timezone = document.getElementById('timezone').value;

      if (granularity === 'daily') {
        // Parse as noon in the selected timezone to avoid date shifting
        const date = new Date(bucket + 'T12:00:00');
        // Format in selected timezone
        const dateStr = date.toLocaleDateString('en-US', {
          timeZone: timezone,
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        });
        return dateStr;
      } else {
        // Hourly: "Mon, 2pm"
        const date = new Date(bucket + ':00:00');
        // Format in selected timezone
        const dateStr = date.toLocaleDateString('en-US', {
          timeZone: timezone,
          weekday: 'short'
        });
        const timeStr = date.toLocaleTimeString('en-US', {
          timeZone: timezone,
          hour: 'numeric'
        });
        return `${dateStr}, ${timeStr.toLowerCase()}`;
      }
    }

    function updateChart() {
      const showNew = document.getElementById('toggle-new').checked;
      const showRenewal = document.getElementById('toggle-renewal').checked;
      const showSpend = document.getElementById('toggle-spend').checked;

      // Grey out row numbers when deselected
      document.querySelectorAll('#new-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showNew ? 'white' : '#6B7280';
      });
      document.querySelectorAll('#renewal-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showRenewal ? 'white' : '#6B7280';
      });
      document.querySelectorAll('#spend-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showSpend ? 'white' : '#6B7280';
      });

      const labels = processedData.map(d => formatLabel(d.bucket));
      const datasets = [];

      // Create datasets with specific indices for sorting
      const datasetMap = {};

      if (showNew) {
        datasetMap[0] = {
          label: 'New',
          data: processedData.map(d => d.newPurchases),
          borderColor: '#74C583',
          backgroundColor: 'rgba(69, 118, 78, 1)', // Semi-transparent #45764E
          borderWidth: 2,
          fill: true,
          tension: 0,
          pointRadius: 0,
          order: 3, // Render in back (z-index)
        };
      }

      if (showRenewal) {
        datasetMap[1] = {
          label: 'Renewal',
          data: processedData.map(d => d.renewals),
          borderColor: '#9AFCF1',
          backgroundColor: '#5C9790',
          borderWidth: 2,
          fill: true,
          tension: 0,
          pointRadius: 0,
          order: 1, // Render on top (z-index)
        };
      }

      if (showSpend) {
        datasetMap[2] = {
          label: 'Ad Spend',
          data: processedData.map(d => d.spend),
          borderColor: '#EF4444', // More muted red
          backgroundColor: 'rgba(220, 38, 38, 0.7)', // Semi-transparent darker red
          borderWidth: 2,
          fill: true,
          tension: 0,
          pointRadius: 0,
          order: 2, // Render in middle (z-index)
        };
      }

      // Add datasets in index order (0, 1, 2) to ensure New, Renewal, Spend order
      for (let i = 0; i < 3; i++) {
        if (datasetMap[i]) {
          datasets.push(datasetMap[i]);
        }
      }

      // Add a vertical annotation for the incomplete current hour
      const currentHour = new Date();
      currentHour.setMinutes(0, 0, 0);
      const currentHourFormatted = currentHour.toISOString().slice(0, 13);

      if (chart) chart.destroy();

      chart = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: false,
              external: function(context) {
                // Custom HTML tooltip
                let tooltipEl = document.getElementById('chartjs-tooltip');

                if (!tooltipEl) {
                  tooltipEl = document.createElement('div');
                  tooltipEl.id = 'chartjs-tooltip';
                  tooltipEl.style.background = 'rgba(31, 41, 55, 0.95)';
                  tooltipEl.style.borderRadius = '8px';
                  tooltipEl.style.color = 'white';
                  tooltipEl.style.opacity = 1;
                  tooltipEl.style.pointerEvents = 'none';
                  tooltipEl.style.position = 'absolute';
                  tooltipEl.style.transition = 'all .1s ease';
                  tooltipEl.style.padding = '12px';
                  tooltipEl.style.fontFamily = 'monospace';
                  tooltipEl.style.fontSize = '12px';
                  tooltipEl.style.border = '1px solid #374151';
                  document.body.appendChild(tooltipEl);
                }

                const tooltipModel = context.tooltip;

                if (tooltipModel.opacity === 0) {
                  tooltipEl.style.opacity = 0;
                  return;
                }

                if (tooltipModel.dataPoints) {
                  const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                  const data = processedData[dataIndex];

                  if (data) {
                    const items = tooltipModel.dataPoints;
                    const label = formatLabel(data.bucket);

                    // Calculate hours/days ago
                    let timeAgoText = '';
                    if (granularity === 'hourly') {
                      const bucketDate = new Date(data.bucket + ':00:00');
                      const hoursAgo = Math.floor((new Date() - bucketDate) / (1000 * 60 * 60));
                      if (!isNaN(hoursAgo) && hoursAgo >= 0) {
                        timeAgoText = ` <span style="color: #9CA3AF;">${hoursAgo} hour${hoursAgo !== 1 ? 's' : ''} ago</span>`;
                      }
                    } else {
                      // Daily - calculate days ago
                      const bucketDate = new Date(data.bucket + 'T12:00:00');
                      const now = new Date();
                      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                      const bucketStart = new Date(bucketDate.getFullYear(), bucketDate.getMonth(), bucketDate.getDate());
                      const daysAgo = Math.floor((todayStart - bucketStart) / (1000 * 60 * 60 * 24));
                      if (!isNaN(daysAgo) && daysAgo >= 0) {
                        if (daysAgo === 0) {
                          timeAgoText = ` <span style="color: #9CA3AF;">today</span>`;
                        } else if (daysAgo === 1) {
                          timeAgoText = ` <span style="color: #9CA3AF;">yesterday</span>`;
                        } else {
                          timeAgoText = ` <span style="color: #9CA3AF;">${daysAgo} days ago</span>`;
                        }
                      }
                    }

                    // Build HTML content with table for alignment
                    let innerHtml = `<div style="margin-bottom: 8px; display: flex; justify-content: space-between;"><span>${label}</span>${timeAgoText}</div>`;

                    // Gross Proceeds
                    const grossProceeds = data.newPurchases + data.renewals;

                    // Find each dataset in order
                    const newItem = items.find(item => item.dataset.label === 'New');
                    const renewalItem = items.find(item => item.dataset.label === 'Renewal');
                    const spendItem = items.find(item => item.dataset.label === 'Ad Spend');

                    // Net Profit
                    const netProfit = grossProceeds - data.spend;

                    const numColor = '#9AFCF1';
                    const netProfitColor = netProfit >= 0 ? '#4ADE80' : '#EF4444';

                    innerHtml += `<table style="border-collapse: collapse; width: 100%;">`;
                    innerHtml += `<tr style="margin-bottom: 6px;"><td>Gross Proceeds</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${grossProceeds.toFixed(2)}</td></tr>`;
                    if (newItem) {
                      innerHtml += `<tr><td><span style="color: #4ADE80;">●</span> New</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${newItem.raw.toFixed(2)}</td></tr>`;
                    }
                    if (renewalItem) {
                      innerHtml += `<tr><td><span style="color: #22D3D3;">●</span> Renewal</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${renewalItem.raw.toFixed(2)}</td></tr>`;
                    }
                    if (spendItem) {
                      innerHtml += `<tr><td><span style="color: #EF4444;">●</span> Spend</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${spendItem.raw.toFixed(2)}</td></tr>`;
                    }
                    innerHtml += `<tr style="margin-top: 6px;"><td>Net Profit</td><td style="text-align: right; padding-left: 16px; color: ${netProfitColor};">$${netProfit.toFixed(2)}</td></tr>`;
                    innerHtml += `</table>`;

                    tooltipEl.innerHTML = innerHtml;
                  }
                }

                const position = context.chart.canvas.getBoundingClientRect();

                // Display, position, and set styles for font
                tooltipEl.style.opacity = 1;

                // Use event position for mouse-following tooltip
                const eventX = tooltipModel.caretX;
                const eventY = tooltipModel.caretY;

                // Calculate initial position
                let left = position.left + window.pageXOffset + eventX;
                let top = position.top + window.pageYOffset + eventY - 60;

                // Get tooltip dimensions (need to temporarily display it to measure)
                tooltipEl.style.visibility = 'hidden';
                tooltipEl.style.display = 'block';
                const tooltipWidth = tooltipEl.offsetWidth;
                const tooltipHeight = tooltipEl.offsetHeight;
                tooltipEl.style.visibility = 'visible';

                // Check if tooltip would go off the right edge
                if (left + tooltipWidth > window.innerWidth + window.pageXOffset - 10) {
                  // Position to the left of the cursor instead
                  left = position.left + window.pageXOffset + eventX - tooltipWidth - 10;
                }

                // Check if tooltip would go off the left edge
                if (left < window.pageXOffset + 10) {
                  left = window.pageXOffset + 10;
                }

                // Check if tooltip would go off the top
                if (top < window.pageYOffset + 10) {
                  // Position below the cursor instead
                  top = position.top + window.pageYOffset + eventY + 10;
                }

                // Apply the calculated position
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
              },
            },
            annotation: {
              annotations: {
                incompleteHour: {
                  type: 'box',
                  xMin: processedData.length > 0 ? processedData.length - 1 : 0,
                  xMax: processedData.length > 0 ? processedData.length : 1,
                  backgroundColor: 'rgba(0, 0, 0, 0.2)',
                  borderWidth: 0,
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#666666',
                font: {
                  size: 11,
                },
                maxRotation: 0,
                minRotation: 0,
                autoSkip: true,
                maxTicksLimit: 12,
                callback: function(value, index) {
                  // Skip the first label to prevent overlap with y-axis
                  if (index === 0) return '';
                  return this.getLabelForValue(value);
                },
                display: true,
              },
              grid: {
                display: true,
                drawOnChartArea: false, // Only draw ticks, not grid lines
                drawTicks: true,
                tickLength: 5,
                tickColor: '#666666',
                drawBorder: true,
                borderColor: '#374151',
              },
            },
            y: {
              ticks: {
                color: '#666666',
                font: {
                  size: 11,
                },
                callback: v => {
                  if (v >= 1000) {
                    // For values >= 1000, use K notation with 1 decimal for fractional values
                    const kValue = v / 1000;
                    if (kValue % 1 === 0) {
                      return '$' + kValue.toFixed(0) + 'K';
                    } else {
                      return '$' + kValue.toFixed(1) + 'K';
                    }
                  } else {
                    // For values < 1000, show the actual number
                    return '$' + v.toFixed(0);
                  }
                },
              },
              grid: {
                color: '#374151',
                drawBorder: false,
              },
            },
          },
        },
      });

      // Hide tooltip when touching outside the chart on mobile
      document.addEventListener('touchstart', function(e) {
        const chartCanvas = document.getElementById('chart');
        const tooltipEl = document.getElementById('chartjs-tooltip');
        if (tooltipEl && !chartCanvas.contains(e.target)) {
          tooltipEl.style.opacity = 0;
        }
      }, { passive: true });
    }

    function updateTable() {
      const headerRow = document.getElementById('table-header');
      const newRow = document.getElementById('new-row');
      const renewalRow = document.getElementById('renewal-row');
      const spendRow = document.getElementById('spend-row');

      // Clear existing data cells (keep first sticky column)
      while (headerRow.children.length > 1) headerRow.removeChild(headerRow.lastChild);
      while (newRow.children.length > 1) newRow.removeChild(newRow.lastChild);
      while (renewalRow.children.length > 1) renewalRow.removeChild(renewalRow.lastChild);
      while (spendRow.children.length > 1) spendRow.removeChild(spendRow.lastChild);

      // Add data columns for each time period
      processedData.forEach(row => {
        // Header - format date
        const th = document.createElement('th');
        const date = new Date(row.bucket + ':00:00');
        const timezone = document.getElementById('timezone').value;

        if (granularity === 'daily') {
          th.textContent = date.toLocaleDateString('en-US', {
            timeZone: timezone,
            weekday: 'short',
            month: 'short',
            day: 'numeric'
          });
        } else {
          // Hourly format: "Mon, 8pm"
          const weekday = date.toLocaleDateString('en-US', {
            timeZone: timezone,
            weekday: 'short'
          });
          const time = date.toLocaleTimeString('en-US', {
            timeZone: timezone,
            hour: 'numeric'
          }).toLowerCase();
          th.textContent = `${weekday}, ${time}`;
        }
        headerRow.appendChild(th);

        // New
        const newTd = document.createElement('td');
        newTd.textContent = '$' + row.newPurchases.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        newTd.style.color = 'white';
        newRow.appendChild(newTd);

        // Renewal
        const renewalTd = document.createElement('td');
        renewalTd.textContent = '$' + row.renewals.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        renewalTd.style.color = 'white';
        renewalRow.appendChild(renewalTd);

        // Spend
        const spendTd = document.createElement('td');
        spendTd.textContent = '$' + row.spend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        spendTd.style.color = 'white';
        spendRow.appendChild(spendTd);
      });

      // Add total column
      const totals = processedData.reduce((acc, d) => ({
        newPurchases: acc.newPurchases + d.newPurchases,
        renewals: acc.renewals + d.renewals,
        spend: acc.spend + d.spend,
      }), { newPurchases: 0, renewals: 0, spend: 0 });

      // Total header
      const totalTh = document.createElement('th');
      totalTh.textContent = 'Total';
      totalTh.style.color = '#9CA3AF';
      headerRow.appendChild(totalTh);

      // Total new
      const totalNewTd = document.createElement('td');
      totalNewTd.textContent = '$' + totals.newPurchases.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalNewTd.style.color = 'white';
      totalNewTd.style.fontWeight = '600';
      newRow.appendChild(totalNewTd);

      // Total renewal
      const totalRenewalTd = document.createElement('td');
      totalRenewalTd.textContent = '$' + totals.renewals.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalRenewalTd.style.color = 'white';
      totalRenewalTd.style.fontWeight = '600';
      renewalRow.appendChild(totalRenewalTd);

      // Total spend
      const totalSpendTd = document.createElement('td');
      totalSpendTd.textContent = '$' + totals.spend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalSpendTd.style.color = 'white';
      totalSpendTd.style.fontWeight = '600';
      spendRow.appendChild(totalSpendTd);

      // Scroll table to the right to show most recent data and totals
      const tableContainer = document.querySelector('.chart-container[style*="overflow-x"]');
      if (tableContainer) {
        setTimeout(() => {
          tableContainer.scrollLeft = tableContainer.scrollWidth;
        }, 0);
      }
    }

    function updateTransactions() {
      const tbody = document.getElementById('transactions-tbody');
      tbody.innerHTML = '';

      // Sort revenue data by created_at descending (most recent first)
      const sortedTransactions = [...revenueData].sort((a, b) =>
        new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
      );

      // Determine how many to show (initial 16, max 50)
      const initialShow = 16;
      const maxShow = 50;
      const limit = showAllTransactions ? Math.min(sortedTransactions.length, maxShow) : initialShow;
      const transactionsToShow = sortedTransactions.slice(0, limit);
      const remainingCount = Math.max(0, Math.min(sortedTransactions.length, maxShow) - initialShow);

      // Update the "Show more" button
      const showMoreContainer = document.getElementById('show-more-container');
      const moreText = document.getElementById('more-text');

      if (remainingCount > 0 && !showAllTransactions) {
        showMoreContainer.style.display = 'block';
        moreText.textContent = `Show ${remainingCount} more`;
      } else if (showAllTransactions && sortedTransactions.length > initialShow) {
        showMoreContainer.style.display = 'block';
        moreText.textContent = 'Show less';
        document.querySelector('#show-more-btn span:last-child').textContent = '↑';
      } else {
        showMoreContainer.style.display = 'none';
      }

      // Add rows
      transactionsToShow.forEach((transaction, index) => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #2D3748';

        // Parse raw payload for extra data
        let parsedPayload = null;
        let countryCode = 'US';
        let appUserId = null;
        let productIdFromPayload = null;

        try {
          if (transaction.raw_payload) {
            // Check if raw_payload is already an object or needs parsing
            if (typeof transaction.raw_payload === 'string') {
              parsedPayload = JSON.parse(transaction.raw_payload);
            } else {
              parsedPayload = transaction.raw_payload;
            }

            if (parsedPayload && parsedPayload.data) {
              // Get country code
              countryCode = parsedPayload.data.countryCode || 'US';

              // Get productId from data
              productIdFromPayload = parsedPayload.data.productId;

              // Get appUserId from userAttributes
              if (parsedPayload.data.userAttributes) {
                appUserId = parsedPayload.data.userAttributes.appUserId;
              }
            }
          }
        } catch (e) {
          // Silently handle errors
        }

        // Use appUserId from payload, fallback to user_id from transaction
        let userId = appUserId || transaction.user_id || '';
        let productId = productIdFromPayload || transaction.product_id || '';

        // Get country flag
        const getCountryFlag = (code) => {
          const flags = {
            'US': '🇺🇸',
            'GB': '🇬🇧',
            'CA': '🇨🇦',
            'AU': '🇦🇺',
            'NZ': '🇳🇿',
            'IE': '🇮🇪',
            'DE': '🇩🇪',
            'FR': '🇫🇷',
            'IT': '🇮🇹',
            'ES': '🇪🇸',
            'PT': '🇵🇹',
            'NL': '🇳🇱',
            'BE': '🇧🇪',
            'CH': '🇨🇭',
            'AT': '🇦🇹',
            'SE': '🇸🇪',
            'NO': '🇳🇴',
            'DK': '🇩🇰',
            'FI': '🇫🇮',
            'PL': '🇵🇱',
            'RU': '🇷🇺',
            'UA': '🇺🇦',
            'JP': '🇯🇵',
            'KR': '🇰🇷',
            'CN': '🇨🇳',
            'IN': '🇮🇳',
            'SG': '🇸🇬',
            'MY': '🇲🇾',
            'TH': '🇹🇭',
            'ID': '🇮🇩',
            'PH': '🇵🇭',
            'VN': '🇻🇳',
            'BR': '🇧🇷',
            'MX': '🇲🇽',
            'AR': '🇦🇷',
            'CO': '🇨🇴',
            'CL': '🇨🇱',
            'PE': '🇵🇪',
            'ZA': '🇿🇦',
            'EG': '🇪🇬',
            'TR': '🇹🇷',
            'IL': '🇮🇱',
            'SA': '🇸🇦',
            'AE': '🇦🇪'
          };
          return flags[code] || '🏳️';
        };

        // Format user ID - truncate for display
        const formatUserId = () => {
          if (userId) {
            // For UUIDs like D77162D1-57D0-4CC5-8FBE-680DC6BF7A5C
            // Show first 6 and last 6 characters
            if (userId.length > 12) {
              return userId.substring(0, 6).toUpperCase() + '...' + userId.substring(userId.length - 6).toUpperCase();
            }
            return userId.toUpperCase();
          }
          return '—';
        };

        // Format product name
        const formatProductName = (pid) => {
          if (!pid) return '—';
          const cleaned = pid.replace(/^br_/, '');

          // Map product IDs to display names
          const productMap = {
            '499_1w': '$4.99/wk',
            '2499_1y': '$24.99/yr',
            '4999_1y': '$49.99/yr'
          };

          if (productMap[cleaned]) {
            return productMap[cleaned];
          }

          // Fallback patterns
          if (cleaned.includes('_1y')) {
            const price = cleaned.replace('_1y', '');
            return `$${(parseInt(price) / 100).toFixed(2)}/yr`;
          }
          if (cleaned.includes('_1w')) {
            const price = cleaned.replace('_1w', '');
            return `$${(parseInt(price) / 100).toFixed(2)}/wk`;
          }

          return cleaned;
        };

        // Format time
        const formatTime = (dateStr) => {
          const date = new Date(dateStr);
          const timezone = document.getElementById('timezone').value;
          return date.toLocaleTimeString('en-US', {
            timeZone: timezone,
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          }).toLowerCase().replace(' ', '');
        };

        // Format type
        const getTypeDisplay = (eventType, isRefund) => {
          if (isRefund) {
            return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #2D3748; padding: 4px 12px; border-radius: 16px; color: #EF4444; font-weight: 500;">🔴 Refund</span>`;
          }
          switch(eventType) {
            case 'initial_purchase':
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #1F3A2E; padding: 4px 12px; border-radius: 16px; color: #4ADE80; font-weight: 500;">🍎 Direct Sub Start</span>`;
            case 'renewal':
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #2D3748; padding: 4px 12px; border-radius: 16px; color: #9CA3AF; font-weight: 500;">🔄 Renewal</span>`;
            case 'cancellation':
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #3A2A1F; padding: 4px 12px; border-radius: 16px; color: #F59E0B; font-weight: 500;">🟠 Sub Cancel</span>`;
            default:
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #2D3748; padding: 4px 12px; border-radius: 16px; color: #9CA3AF; font-weight: 500;">⚪ ${eventType}</span>`;
          }
        };

        const typeDisplay = getTypeDisplay(transaction.event_type, transaction.is_refund);

        // User cell
        const userTd = document.createElement('td');
        userTd.style.padding = '6px';
        userTd.style.color = 'white';
        userTd.style.fontSize = '0.8125rem';
        const flag = getCountryFlag(countryCode);
        userTd.innerHTML = `<span style="margin-right: 6px;">${flag}</span><span>${formatUserId()}</span>`;
        tr.appendChild(userTd);

        // Product cell
        const productTd = document.createElement('td');
        productTd.style.padding = '6px';
        productTd.style.color = 'white';
        productTd.style.fontSize = '0.8125rem';
        productTd.textContent = formatProductName(productId);
        tr.appendChild(productTd);

        // Revenue cell
        const revenueTd = document.createElement('td');
        revenueTd.style.padding = '6px';
        revenueTd.style.color = 'white';
        revenueTd.style.fontSize = '0.8125rem';
        const proceeds = parseFloat(transaction.proceeds) || 0;
        revenueTd.textContent = proceeds > 0 ? '$' + proceeds.toFixed(2) : '—';
        tr.appendChild(revenueTd);

        // When cell
        const whenTd = document.createElement('td');
        whenTd.style.padding = '6px';
        whenTd.style.color = '#9CA3AF';
        whenTd.style.fontSize = '0.8125rem';
        whenTd.textContent = formatTime(transaction.created_at);
        tr.appendChild(whenTd);

        // Type cell
        const typeTd = document.createElement('td');
        typeTd.style.padding = '6px';
        typeTd.style.fontSize = '0.8125rem';
        typeTd.innerHTML = typeDisplay;
        tr.appendChild(typeTd);

        tbody.appendChild(tr);
      });

      // If no transactions
      if (transactionsToShow.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.style.padding = '24px';
        td.style.textAlign = 'center';
        td.style.color = '#6B7280';
        td.textContent = 'No transactions found';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function toggleShowMore() {
      showAllTransactions = !showAllTransactions;
      updateTransactions();
    }

    // Password gate
    const CORRECT_PASSWORD_HASH = '107458b366671198f2e4845cc0a436f532c1e5db47d61c79d2ad11aa419cc980';

    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function checkPassword(event) {
      event.preventDefault();
      const password = document.getElementById('password-input').value;
      const hash = await hashPassword(password);

      if (hash === CORRECT_PASSWORD_HASH) {
        localStorage.setItem('brainrot_auth', hash);
        showDashboard();
      } else {
        document.getElementById('password-error').style.display = 'block';
        document.getElementById('password-input').value = '';
      }
      return false;
    }

    function showDashboard() {
      document.getElementById('password-gate').classList.add('hidden');
      document.getElementById('dashboard-content').classList.add('visible');
      fetchData();
    }

    // Check if already authenticated
    async function checkAuth() {
      const storedHash = localStorage.getItem('brainrot_auth');
      if (storedHash === CORRECT_PASSWORD_HASH) {
        showDashboard();
      }
    }

    checkAuth();

    // Pull to refresh (mobile only) - native feel
    let pullStartY = 0;
    let currentPullDistance = 0;
    let isPulling = false;
    let isRefreshing = false;
    let hasTriggeredHaptic = false;
    const pullThreshold = 60;
    const maxPull = 120;

    const spinner = document.getElementById('ptr-spinner');
    const dashboard = document.getElementById('dashboard-content');

    // Haptic feedback helper
    function haptic(style = 'light') {
      if ('vibrate' in navigator) {
        if (style === 'light') navigator.vibrate(10);
        else if (style === 'medium') navigator.vibrate(20);
        else if (style === 'success') navigator.vibrate([10, 50, 20]);
      }
    }

    document.addEventListener('touchstart', (e) => {
      if (isRefreshing) return;

      // Check if we're at the top
      if (window.scrollY <= 0) {
        pullStartY = e.touches[0].clientY;
        isPulling = true;
        hasTriggeredHaptic = false;
        currentPullDistance = 0;
        dashboard.style.transition = 'none';
        spinner.style.transition = 'none';
      }
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!isPulling || isRefreshing) return;

      const currentY = e.touches[0].clientY;
      const rawPull = currentY - pullStartY;

      // Only activate when pulling down and at top of page
      if (rawPull > 0 && window.scrollY <= 0) {
        // Apply resistance curve - gets harder to pull as you go
        const resistance = Math.max(0.4 - (rawPull / 1000), 0.2);
        currentPullDistance = Math.min(rawPull * resistance, maxPull);

        // Move the entire dashboard content down
        dashboard.style.transform = `translateY(${currentPullDistance}px)`;

        // Position and show spinner
        spinner.style.top = `${currentPullDistance - 30}px`;
        spinner.style.opacity = Math.min(currentPullDistance / pullThreshold, 1);
        spinner.classList.add('visible');

        // Rotate spinner based on pull progress
        const rotation = (currentPullDistance / pullThreshold) * 360;
        spinner.querySelector('svg').style.transform = `rotate(${rotation}deg)`;

        // Haptic when crossing threshold
        if (currentPullDistance >= pullThreshold && !hasTriggeredHaptic) {
          hasTriggeredHaptic = true;
          haptic('medium');
        } else if (currentPullDistance < pullThreshold && hasTriggeredHaptic) {
          hasTriggeredHaptic = false;
        }
      }
    }, { passive: true });

    document.addEventListener('touchend', async () => {
      if (!isPulling || isRefreshing) return;
      isPulling = false;

      dashboard.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
      spinner.style.transition = 'top 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease';

      if (currentPullDistance >= pullThreshold) {
        // Trigger refresh
        isRefreshing = true;
        haptic('success');

        // Hold at refresh position
        dashboard.style.transform = 'translateY(50px)';
        spinner.style.top = '20px';
        spinner.style.opacity = '1';
        spinner.classList.add('refreshing');

        await fetchData(true);

        // Small delay so user sees the refresh happened
        await new Promise(resolve => setTimeout(resolve, 300));

        // Animate back
        spinner.classList.remove('refreshing');
        dashboard.style.transform = 'translateY(0)';
        spinner.style.opacity = '0';

        setTimeout(() => {
          spinner.classList.remove('visible');
          isRefreshing = false;
        }, 300);
      } else {
        // Snap back
        dashboard.style.transform = 'translateY(0)';
        spinner.style.opacity = '0';
        setTimeout(() => {
          spinner.classList.remove('visible');
        }, 300);
      }

      currentPullDistance = 0;
    }, { passive: true });
  </script>
</body>
</html>