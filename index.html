<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smolworks Dashboard</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="smolworks-icon.png">
  <link rel="apple-touch-icon" href="smolworks-icon.png">

  <!-- Meta tags for better SEO and sharing -->
  <meta name="description" content="Real-time analytics dashboard - track revenue, conversions, and ad spend">
  <meta name="author" content="Smolworks">
  <meta name="theme-color" content="#13151A">

  <!-- Open Graph tags for social sharing -->
  <meta property="og:title" content="Smolworks Dashboard">
  <meta property="og:description" content="Real-time analytics dashboard">
  <meta property="og:image" content="smolworks-icon.png">
  <meta property="og:type" content="website">

  <!-- Apple specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Smolworks">
  <link rel="manifest" href="manifest.json">

  <!-- Shared styles -->
  <link rel="stylesheet" href="shared.css">

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script src="shared.js"></script>
  <style>
    /* Page-specific styles for index.html */
    #data-table { min-width: 100%; }

    @media (max-width: 600px) {
      #transactions-table {
        zoom: 0.7;
      }
    }

    /* Checkbox toggle styles */
    input[type="checkbox"]:not(:checked) + label {
      background: transparent !important;
      border: 2px solid;
    }
    input#toggle-new:not(:checked) + label {
      border-color: #4ADE80;
    }
    input#toggle-renewal:not(:checked) + label {
      border-color: #22D3D3;
    }
    input#toggle-spend:not(:checked) + label {
      border-color: #EF4444;
    }
  </style>
</head>
<body>
  <!-- Pull to refresh spinner -->
  <div id="ptr-spinner" class="ptr-spinner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
    </svg>
  </div>

  <!-- Password Gate -->
  <div id="password-gate" class="password-gate">
    <div class="password-form">
      <img src="smolworks-icon.png" alt="Smolworks">
      <h2>Smolworks Dashboard</h2>
      <p>Enter password to continue</p>
      <form onsubmit="return checkPassword(event)">
        <input type="password" id="password-input" placeholder="Password" autocomplete="current-password">
        <button type="submit">Enter</button>
      </form>
      <div id="password-error" class="password-error">Incorrect password</div>
    </div>
  </div>

  <div class="container dashboard-content" id="dashboard-content">
    <header class="main-header">
      <div class="nav-dropdown">
        <img src="smolworks-icon.png" alt="Smolworks" class="header-icon" style="width: 32px; height: 32px; border-radius: 8px; object-fit: cover; cursor: pointer;" onclick="toggleNavDropdown()">
        <div class="nav-dropdown-menu" id="nav-dropdown-menu">
          <a href="index.html?app=smolworks" class="nav-dropdown-item">
            <img src="smolworks-icon.png" alt="" class="nav-item-icon">
            Smolworks
          </a>
          <a href="index.html?app=brainrot" class="nav-dropdown-item">
            <img src="brainrot-icon.png" alt="" class="nav-item-icon">
            Brainrot
          </a>
          <a href="index.html?app=catchr" class="nav-dropdown-item">
            <img src="catchr-icon.webp" alt="" class="nav-item-icon">
            Catchr
          </a>
        </div>
      </div>
      <div class="header-title">
        <h1>Smolworks</h1>
        <div class="updated" id="updated"></div>
      </div>
      <!-- Hamburger menu for mobile -->
      <div class="hamburger-menu">
        <button class="hamburger-btn" onclick="toggleHamburgerMenu()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div id="hamburger-dropdown" class="hamburger-dropdown">
          <div class="menu-section">
            <div class="menu-label">View</div>
            <a href="index.html" class="menu-option menu-view-tab active" id="menu-view-overview">Overview</a>
            <a href="ads.html" class="menu-option menu-view-tab" id="menu-view-ads">Ads</a>
          </div>
          <div class="menu-section">
            <div class="menu-label">Time Range</div>
            <div class="menu-option" onclick="selectTimeRange('24h')">Last 24 Hours</div>
            <div class="menu-option" onclick="selectTimeRange('today')">Today</div>
            <div class="menu-option" onclick="selectTimeRange('yesterday')">Yesterday</div>
            <div class="menu-option" onclick="selectTimeRange('7d')">Last 7 Days</div>
            <div class="menu-option" onclick="selectTimeRange('14d')">Last 14 Days</div>
            <div class="menu-option" onclick="selectTimeRange('30d')">Last 30 Days</div>
            <div class="menu-option" onclick="selectTimeRange('90d')">Last 90 Days</div>
            <div class="menu-option" onclick="selectTimeRange('180d')">Last 180 Days</div>
          </div>
          <div class="menu-section">
            <div class="menu-label">Timezone</div>
            <div class="menu-option" onclick="selectTimezone('America/Los_Angeles')">PST</div>
            <div class="menu-option" onclick="selectTimezone('America/New_York')">EST</div>
          </div>
          <div class="menu-section">
            <div class="menu-option" onclick="fetchData(true); toggleHamburgerMenu();">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Refresh
            </div>
          </div>
        </div>
      </div>
      <!-- Desktop controls -->
      <div class="controls desktop-controls">
        <select id="view-select" onchange="handleViewChange(this.value)">
          <option value="overview" selected>Overview</option>
          <option value="ads">Ads</option>
        </select>
        <select id="time-range" onchange="handleTimeRangeChange()">
          <option value="24h" selected>Last 24 Hours</option>
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="7d">Last 7 Days</option>
          <option value="14d">Last 14 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="90d">Last 90 Days</option>
          <option value="180d">Last 180 Days</option>
        </select>
        <select id="timezone" onchange="render()">
          <option value="America/Los_Angeles">PST</option>
          <option value="America/New_York">EST</option>
        </select>
        <button onclick="fetchData(true)" style="padding: 6px 10px; display: flex; align-items: center; justify-content: center;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 4v6h-6"></path>
            <path d="M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
      </div>
    </header>

    <div class="cards">
      <div class="card">
        <div class="skeleton-overlay"><div class="skeleton skeleton-card-value"></div><div class="skeleton skeleton-card-label"></div></div>
        <div class="card-value" id="total-proceeds" style="color: white;">$0</div>
        <div class="card-label">Total Proceeds</div>
      </div>
      <div class="card">
        <div class="skeleton-overlay"><div class="skeleton skeleton-card-value"></div><div class="skeleton skeleton-card-label"></div></div>
        <div class="card-value" id="total-spend" style="color: white;">$0</div>
        <div class="card-label">Ad Spend</div>
      </div>
      <div class="card">
        <div class="skeleton-overlay"><div class="skeleton skeleton-card-value"></div><div class="skeleton skeleton-card-label"></div></div>
        <div class="card-value" id="total-conversions" style="color: white;">0</div>
        <div class="card-label">Total Conv's</div>
      </div>
      <div class="card">
        <div class="skeleton-overlay"><div class="skeleton skeleton-card-value"></div><div class="skeleton skeleton-card-label"></div></div>
        <div class="card-value" id="initial-conversions" style="color: white;">0</div>
        <div class="card-label">Initial Conv's</div>
      </div>
      <div class="card">
        <div class="skeleton-overlay"><div class="skeleton skeleton-card-value"></div><div class="skeleton skeleton-card-label"></div></div>
        <div class="card-value" id="net-profit" style="color: white;">$0</div>
        <div class="card-label">Net Profit</div>
      </div>
      <div class="card">
        <div class="skeleton-overlay"><div class="skeleton skeleton-card-value"></div><div class="skeleton skeleton-card-label"></div></div>
        <div class="card-value" id="roas" style="color: white;">0.00</div>
        <div class="card-label">ROAS</div>
      </div>
    </div>

    <div class="chart-container" style="position: relative; padding-top: 40px;">
      <div style="position: absolute; top: 12px; right: 16px; z-index: 10;">
        <div class="granularity-dropdown">
          <button id="granularity-toggle" onclick="toggleGranularityDropdown()" style="background: transparent; border: none; color: white; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 8px; font-weight: 500;">
            <span id="granularity-label">Hourly</span>
            <svg width="8" height="5" viewBox="0 0 8 5" fill="none" style="margin-top: 1px;">
              <path d="M1 1L4 4L7 1" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div id="granularity-menu" style="display: none; position: absolute; top: 100%; right: 0; background: #191B1F; border: 1px solid #2A2D35; border-radius: 4px; margin-top: 4px; min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            <div onclick="selectGranularity('hourly')" style="padding: 8px 12px; cursor: pointer; color: white; font-size: 0.75rem;">Hourly</div>
            <div onclick="selectGranularity('daily')" style="padding: 8px 12px; cursor: pointer; color: white; font-size: 0.75rem; border-top: 1px solid #2A2D35;">Daily</div>
          </div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="skeleton-overlay skeleton skeleton-chart"></div>
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="chart-container" style="overflow-x: auto; background: #191B1F; padding: 20px;">
      <div class="skeleton-overlay" style="padding: 0 20px;">
        <div class="skeleton skeleton-table-row" style="width: 100%;"></div>
        <div class="skeleton skeleton-table-row" style="width: 95%;"></div>
        <div class="skeleton skeleton-table-row" style="width: 90%;"></div>
        <div class="skeleton skeleton-table-row" style="width: 85%;"></div>
      </div>
      <table id="data-table">
        <thead>
          <tr id="table-header" style="border-bottom: 1px solid #2A2D35;">
            <th class="sticky-col">
              <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="color: #9CA3AF; font-size: 0.9rem;">$</span>
                  <span style="color: white; font-size: 1rem; font-weight: 500;">Proceeds</span>
                </div>
                <span style="color: #6B7280; font-size: 0.75rem; font-weight: 400;">Renewal Type</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr id="new-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="toggle-new" checked onchange="updateChart()" style="display: none;">
                <label for="toggle-new" style="display: inline-block; width: 12px; height: 12px; background: #4ADE80; border-radius: 2px; cursor: pointer;"></label>
                <span>New</span>
              </div>
            </td>
          </tr>
          <tr id="renewal-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="toggle-renewal" checked onchange="updateChart()" style="display: none;">
                <label for="toggle-renewal" style="display: inline-block; width: 12px; height: 12px; background: #22D3D3; border-radius: 2px; cursor: pointer;"></label>
                <span>Renewal</span>
              </div>
            </td>
          </tr>
          <tr id="meta-spend-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="toggle-spend" checked onchange="updateChart()" style="display: none;">
                <label for="toggle-spend" style="display: inline-block; width: 12px; height: 12px; background: #EF4444; border-radius: 2px; cursor: pointer;"></label>
                <span>Meta Spend</span>
              </div>
            </td>
          </tr>
          <tr id="tiktok-spend-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-block; width: 12px; height: 12px; background: #F97316; border-radius: 2px;"></span>
                <span>TikTok Spend</span>
              </div>
            </td>
          </tr>
          <tr id="apple-spend-row">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-block; width: 12px; height: 12px; background: #60A5FA; border-radius: 2px;"></span>
                <span>Apple Spend</span>
              </div>
            </td>
          </tr>
          <tr id="net-profit-row" style="border-top: 1px solid #2A2D35;">
            <td class="sticky-col">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-block; width: 12px; height: 12px;"></span>
                <span style="font-weight: 500;">Net Profit</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Recent Transactions Section -->
    <div class="chart-container" style="background: #191B1F; padding: 24px; margin-top: 16px;">
      <div style="margin-bottom: 20px;">
        <h2 style="font-size: 1rem; color: white; font-weight: 500;">Recent Transactions</h2>
      </div>
      <div class="skeleton-overlay" id="transactions-skeleton">
        <div class="skeleton-transaction-row"><div class="skeleton" style="width: 100px;"></div><div class="skeleton" style="width: 80px;"></div><div class="skeleton" style="width: 60px;"></div><div class="skeleton" style="width: 50px;"></div><div class="skeleton" style="width: 120px;"></div></div>
        <div class="skeleton-transaction-row"><div class="skeleton" style="width: 100px;"></div><div class="skeleton" style="width: 80px;"></div><div class="skeleton" style="width: 60px;"></div><div class="skeleton" style="width: 50px;"></div><div class="skeleton" style="width: 120px;"></div></div>
        <div class="skeleton-transaction-row"><div class="skeleton" style="width: 100px;"></div><div class="skeleton" style="width: 80px;"></div><div class="skeleton" style="width: 60px;"></div><div class="skeleton" style="width: 50px;"></div><div class="skeleton" style="width: 120px;"></div></div>
        <div class="skeleton-transaction-row"><div class="skeleton" style="width: 100px;"></div><div class="skeleton" style="width: 80px;"></div><div class="skeleton" style="width: 60px;"></div><div class="skeleton" style="width: 50px;"></div><div class="skeleton" style="width: 120px;"></div></div>
        <div class="skeleton-transaction-row"><div class="skeleton" style="width: 100px;"></div><div class="skeleton" style="width: 80px;"></div><div class="skeleton" style="width: 60px;"></div><div class="skeleton" style="width: 50px;"></div><div class="skeleton" style="width: 120px;"></div></div>
      </div>
      <div class="transactions-wrapper" style="overflow-x: auto;">
        <table id="transactions-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #2A2D35;">User</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #2A2D35;">Product</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #2A2D35;">Proceeds</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #2A2D35;">When</th>
              <th style="text-align: left; padding: 4px 6px 6px 6px; color: #6B7280; font-weight: 400; font-size: 0.75rem; border-bottom: 1px solid #2A2D35;">Type</th>
            </tr>
          </thead>
          <tbody id="transactions-tbody">
            <!-- Transactions will be inserted here -->
          </tbody>
        </table>
      </div>
      <div id="show-more-container" style="margin-top: 16px; display: none;">
        <button id="show-more-btn" onclick="toggleShowMore()" style="background: transparent; border: none; color: #60A5FA; cursor: pointer; font-size: 0.8125rem; padding: 8px 0; display: flex; align-items: center; gap: 6px;">
          <span id="more-text">Show 34 more</span>
          <span style="font-size: 0.75rem;">↓</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // App configuration
    const APP_CONFIG = {
      smolworks: {
        id: 'smolworks',
        name: 'Smolworks',
        icon: 'smolworks-icon.png',
        productMap: {
          '499_1w': '$4.99/wk',
          '2499_1y': '$24.99/yr',
          '4999_1y': '$49.99/yr'
        },
        productPrefix: '',
        isCombined: true,
        apps: ['brainrot', 'catchr']
      },
      brainrot: {
        id: 'brainrot',
        name: 'Brainrot',
        icon: 'brainrot-icon.png',
        productMap: {
          '499_1w': '$4.99/wk',
          '2499_1y': '$24.99/yr',
          '4999_1y': '$49.99/yr'
        },
        productPrefix: 'br_'
      },
      catchr: {
        id: 'catchr',
        name: 'Catchr',
        icon: 'catchr-icon.webp',
        productMap: {},
        productPrefix: ''
      }
    };

    // Get app from URL parameter, default to smolworks
    const urlParams = new URLSearchParams(window.location.search);
    const APP_ID = urlParams.get('app') || 'smolworks';
    const APP = APP_CONFIG[APP_ID] || APP_CONFIG.smolworks;

    // Update page elements based on app
    function initAppBranding() {
      // Update page title and header
      document.title = `${APP.name} Dashboard`;
      document.querySelector('.password-form img').src = APP.icon;
      document.querySelector('.password-form h2').textContent = `${APP.name} Dashboard`;
      document.querySelector('.nav-dropdown .header-icon').src = APP.icon;
      document.querySelector('.nav-dropdown .header-icon').alt = APP.name;
      document.querySelector('.header-title h1').textContent = APP.name;

      // Update nav dropdown active state (highlight current app)
      const navItems = document.querySelectorAll('.nav-dropdown-item');
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        const isActive = href.includes(`app=${APP_ID}`);
        item.classList.toggle('active', isActive);
      });

      // Update view tab links in hamburger menu to include app parameter
      const menuViewTabs = document.querySelectorAll('.menu-view-tab');
      menuViewTabs.forEach(tab => {
        const href = tab.getAttribute('href');
        tab.href = `${href}?app=${APP_ID}`;
      });
    }

    // Handle view dropdown change
    function handleViewChange(view) {
      const targetPage = view === 'ads' ? 'ads.html' : 'index.html';
      window.location.href = `${targetPage}?app=${APP_ID}`;
    }

    // Page-specific state
    let chart = null;
    let adsData = [];
    let revenueData = [];  // Lightweight data for charts (no raw_payload)
    let transactionsData = [];  // Full data for transactions table (with raw_payload)
    let processedData = [];
    let showAllTransactions = false;

    async function fetchData(forceRefresh = false) {
      const CACHE_KEY = `${APP_ID}_dashboard_cache`;
      const SUPERWALL_CACHE_KEY = `${APP_ID}_superwall_cache`;
      const TRANSACTIONS_CACHE_KEY = `${APP_ID}_transactions_cache`;
      const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache

      // Check cache first
      if (!forceRefresh) {
        const cached = localStorage.getItem(CACHE_KEY);
        const superwallCached = localStorage.getItem(SUPERWALL_CACHE_KEY);
        const transactionsCached = localStorage.getItem(TRANSACTIONS_CACHE_KEY);

        if (cached && superwallCached && transactionsCached) {
          const cacheData = JSON.parse(cached);
          const swCache = JSON.parse(superwallCached);
          const txCache = JSON.parse(transactionsCached);
          const cacheAge = Date.now() - cacheData.timestamp;
          const swCacheAge = Date.now() - swCache.timestamp;
          const txCacheAge = Date.now() - txCache.timestamp;

          if (cacheAge < CACHE_DURATION && swCacheAge < CACHE_DURATION && txCacheAge < CACHE_DURATION) {
            adsData = cacheData.adsData;
            revenueData = swCache.data;
            transactionsData = txCache.data;
            updateSubtitle();
            render();
            return;
          }
        }
      }

      const headers = {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      };


      // Determine which app IDs to fetch
      const appIds = APP.isCombined ? APP.apps : [APP_ID];

      try {
        // Fetch lightweight revenue data for charts (no raw_payload, with pagination)
        const fetchChartRevenueForApp = async (appId) => {
          let allData = [];
          let offset = 0;
          const limit = 1000;

          while (true) {
            const res = await fetch(
              `${SUPABASE_URL}/rest/v1/superwall_events?select=created_at,proceeds,event_type,product_id&app_id=eq.${appId}&order=created_at.asc&limit=${limit}&offset=${offset}`,
              { headers }
            );
            if (!res.ok) {
              console.error('Fetch error:', res.status, await res.text());
              break;
            }
            const data = await res.json();
            if (!Array.isArray(data)) break;
            allData = allData.concat(data);

            if (data.length < limit) break;
            offset += limit;
          }
          return allData;
        };

        // Fetch recent transactions with full data (including raw_payload)
        const fetchRecentTransactionsForApp = async (appId) => {
          const res = await fetch(
            `${SUPABASE_URL}/rest/v1/superwall_events?select=created_at,proceeds,event_type,user_id,product_id,is_refund,raw_payload,app_id&app_id=eq.${appId}&order=created_at.desc&limit=50`,
            { headers }
          );
          if (!res.ok) return [];
          return await res.json();
        };

        // Generic paginated fetch for ads spend data (only hour_utc + spend)
        const fetchAdsSpendForApp = async (table, appId) => {
          let allData = [];
          let offset = 0;
          const limit = 1000;

          while (true) {
            const res = await fetch(
              `${SUPABASE_URL}/rest/v1/${table}?select=hour_utc,spend&app_id=eq.${appId}&order=hour_utc.asc&limit=${limit}&offset=${offset}`,
              { headers }
            );
            if (!res.ok) {
              console.error('Fetch error:', res.status, await res.text());
              break;
            }
            const data = await res.json();
            if (!Array.isArray(data)) break;
            allData = allData.concat(data);

            if (data.length < limit) break;
            offset += limit;
          }
          return allData;
        };

        // Fetch all data for all apps in parallel
        const [allMetaAdsData, allTikTokAdsData, allAppleAdsData, allRevenueData, allTransactionsData] = await Promise.all([
          Promise.all(appIds.map(id => fetchAdsSpendForApp('meta_ads_hourly', id))),
          Promise.all(appIds.map(id => fetchAdsSpendForApp('tiktok_ads_hourly', id))),
          Promise.all(appIds.map(id => fetchAdsSpendForApp('apple_ads_hourly', id))),
          Promise.all(appIds.map(fetchChartRevenueForApp)),
          Promise.all(appIds.map(fetchRecentTransactionsForApp)),
        ]);

        // Combine Meta + TikTok + Apple ads data (tagged with platform)
        adsData = [
          ...allMetaAdsData.flat().map(r => ({ ...r, _platform: 'meta' })),
          ...allTikTokAdsData.flat().map(r => ({ ...r, _platform: 'tiktok' })),
          ...allAppleAdsData.flat().map(r => ({ ...r, _platform: 'apple' })),
        ];
        revenueData = allRevenueData.flat();
        // For transactions, combine and sort by date, then take top 50
        transactionsData = allTransactionsData.flat()
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .slice(0, 50);

        console.log('Ads data rows fetched:', adsData.length);
        console.log('Revenue data rows fetched:', revenueData.length);
        console.log('Transactions data rows fetched:', transactionsData.length);

        // Save ads data to its own cache (small)
        safeSetItem(CACHE_KEY, JSON.stringify({
          timestamp: Date.now(),
          adsData: adsData
        }));

        // Save lightweight Superwall data to shared cache (used by both pages)
        safeSetItem(SUPERWALL_CACHE_KEY, JSON.stringify({
          timestamp: Date.now(),
          data: revenueData
        }));

        // Save transactions data to separate cache
        safeSetItem(TRANSACTIONS_CACHE_KEY, JSON.stringify({
          timestamp: Date.now(),
          data: transactionsData
        }));

        updateSubtitle();
        render();
      } catch (err) {
        alert('Error fetching data: ' + err.message);
      }
    }

    function render() {
      const { start, end } = getTimeRange();

      const map = new Map();

      // Aggregate ad spend (separate Meta vs TikTok vs Apple)
      (adsData || []).forEach(row => {
        const key = createBucketKey(row.hour_utc, start, end);
        if (key) {
          const existing = map.get(key) || { bucket: key, spend: 0, metaSpend: 0, tiktokSpend: 0, appleSpend: 0, newPurchases: 0, renewals: 0 };
          const amount = parseFloat(row.spend) || 0;
          existing.spend += amount;
          if (row._platform === 'tiktok') {
            existing.tiktokSpend += amount;
          } else if (row._platform === 'apple') {
            existing.appleSpend += amount;
          } else {
            existing.metaSpend += amount;
          }
          map.set(key, existing);
        }
      });

      // Aggregate revenue by type
      (revenueData || []).forEach(row => {
        const key = createBucketKey(row.created_at, start, end);
        if (key) {
          const existing = map.get(key) || { bucket: key, spend: 0, metaSpend: 0, tiktokSpend: 0, appleSpend: 0, newPurchases: 0, renewals: 0 };
          const proceeds = parseFloat(row.proceeds) || 0;

          if (row.event_type === 'renewal') {
            existing.renewals += proceeds;
          } else {
            existing.newPurchases += proceeds;
          }
          map.set(key, existing);
        }
      });

      processedData = Array.from(map.values())
        .map(d => ({
          ...d,
          totalRevenue: d.newPurchases + d.renewals,
          profit: d.newPurchases + d.renewals - d.spend,
        }))
        .sort((a, b) => a.bucket.localeCompare(b.bucket));

      // Update totals
      const totals = processedData.reduce((acc, d) => ({
        spend: acc.spend + d.spend,
        newPurchases: acc.newPurchases + d.newPurchases,
        renewals: acc.renewals + d.renewals,
      }), { spend: 0, newPurchases: 0, renewals: 0 });

      // Count conversions from Superwall revenue data
      const filteredRevenue = (revenueData || []).filter(row => {
        const key = createBucketKey(row.created_at, start, end);
        return key;
      });

      const totalConversions = filteredRevenue.length;
      const initialConversions = filteredRevenue.filter(row => row.event_type === 'initial_purchase').length;

      totals.proceeds = totals.newPurchases + totals.renewals;
      totals.profit = totals.proceeds - totals.spend;

      // Calculate ROAS (Return on Ad Spend) - based on new purchases only
      const roas = totals.spend > 0 ? totals.newPurchases / totals.spend : 0;

      document.getElementById('total-proceeds').innerHTML = '<span class="currency-symbol">$</span>' + totals.proceeds.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('total-conversions').textContent = totalConversions.toLocaleString('en-US');
      document.getElementById('initial-conversions').textContent = initialConversions.toLocaleString('en-US');
      document.getElementById('total-spend').innerHTML = '<span class="currency-symbol">$</span>' + totals.spend.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('roas').textContent = roas.toFixed(2);
      document.getElementById('net-profit').innerHTML = '<span class="currency-symbol">$</span>' + totals.profit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      updateChart();
      updateTable();
      updateTransactions();
      hideSkeletons();
    }

    function updateChart() {
      const showNew = document.getElementById('toggle-new').checked;
      const showRenewal = document.getElementById('toggle-renewal').checked;
      const showSpend = document.getElementById('toggle-spend').checked;

      // Grey out row numbers when deselected
      document.querySelectorAll('#new-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showNew ? 'white' : '#6B7280';
      });
      document.querySelectorAll('#renewal-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showRenewal ? 'white' : '#6B7280';
      });
      document.querySelectorAll('#meta-spend-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showSpend ? 'white' : '#6B7280';
      });
      document.querySelectorAll('#tiktok-spend-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showSpend ? 'white' : '#6B7280';
      });
      document.querySelectorAll('#apple-spend-row td:not(.sticky-col)').forEach(td => {
        td.style.color = showSpend ? 'white' : '#6B7280';
      });

      const labels = processedData.map(d => formatBucketLabel(d.bucket));
      const datasets = [];

      // Create datasets with specific indices for sorting
      const datasetMap = {};

      if (showNew) {
        datasetMap[0] = {
          label: 'New',
          data: processedData.map(d => d.newPurchases),
          borderColor: '#74C583',
          backgroundColor: 'rgba(69, 118, 78, 1)', // Semi-transparent #45764E
          borderWidth: 2,
          fill: true,
          tension: 0,
          pointRadius: 0,
          order: 3, // Render in back (z-index)
        };
      }

      if (showRenewal) {
        datasetMap[1] = {
          label: 'Renewal',
          data: processedData.map(d => d.renewals),
          borderColor: '#9AFCF1',
          backgroundColor: 'rgba(92, 151, 144, 0.75)',
          borderWidth: 2,
          fill: true,
          tension: 0,
          pointRadius: 0,
          order: 1, // Render on top (z-index)
        };
      }

      if (showSpend) {
        // Meta Spend: base layer, fills down to x-axis
        datasetMap[2] = {
          label: 'Meta Spend',
          data: processedData.map(d => d.metaSpend),
          borderColor: '#EF4444',
          backgroundColor: 'rgba(220, 38, 38, 0.7)',
          borderWidth: 2,
          fill: true,
          tension: 0,
          pointRadius: 0,
          order: 2,
        };
        // TikTok Spend: stacked on top of Meta (data = meta + tiktok, fill between this and Meta)
        datasetMap[3] = {
          label: 'TikTok Spend',
          data: processedData.map(d => d.metaSpend + d.tiktokSpend),
          borderColor: '#F97316',
          backgroundColor: 'rgba(234, 88, 12, 0.7)',
          borderWidth: 2,
          fill: '-1', // Fill between this dataset and the previous one (Meta Spend)
          tension: 0,
          pointRadius: 0,
          order: 2,
        };
        // Apple Spend: stacked on top of TikTok (data = meta + tiktok + apple, fill between this and TikTok)
        datasetMap[4] = {
          label: 'Apple Spend',
          data: processedData.map(d => d.metaSpend + d.tiktokSpend + d.appleSpend),
          borderColor: '#60A5FA',
          backgroundColor: 'rgba(59, 130, 246, 0.7)',
          borderWidth: 2,
          fill: '-1',
          tension: 0,
          pointRadius: 0,
          order: 2,
        };
      }

      // Add datasets in index order to ensure New, Renewal, Meta Spend, TikTok Spend, Apple Spend order
      for (let i = 0; i < 5; i++) {
        if (datasetMap[i]) {
          datasets.push(datasetMap[i]);
        }
      }

      // Add a vertical annotation for the incomplete current hour
      const currentHour = new Date();
      currentHour.setMinutes(0, 0, 0);
      const currentHourFormatted = currentHour.toISOString().slice(0, 13);

      if (chart) chart.destroy();

      chart = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: false,
              external: function(context) {
                // Custom HTML tooltip
                let tooltipEl = document.getElementById('chartjs-tooltip');

                if (!tooltipEl) {
                  tooltipEl = document.createElement('div');
                  tooltipEl.id = 'chartjs-tooltip';
                  tooltipEl.style.background = 'rgba(25, 27, 31, 0.95)';
                  tooltipEl.style.borderRadius = '8px';
                  tooltipEl.style.color = 'white';
                  tooltipEl.style.opacity = 1;
                  tooltipEl.style.pointerEvents = 'none';
                  tooltipEl.style.position = 'absolute';
                  tooltipEl.style.transition = 'all .1s ease';
                  tooltipEl.style.padding = '12px';
                  tooltipEl.style.fontFamily = 'monospace';
                  tooltipEl.style.fontSize = '12px';
                  tooltipEl.style.border = '1px solid #2A2D35';
                  document.body.appendChild(tooltipEl);
                }

                const tooltipModel = context.tooltip;

                if (tooltipModel.opacity === 0) {
                  tooltipEl.style.opacity = 0;
                  return;
                }

                if (tooltipModel.dataPoints) {
                  const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                  const data = processedData[dataIndex];

                  if (data) {
                    const items = tooltipModel.dataPoints;
                    const label = formatBucketLabel(data.bucket);

                    // Calculate hours/days ago
                    // Bucket is in PST, so parse with -08:00 offset
                    let timeAgoText = '';
                    if (granularity === 'hourly') {
                      const bucketDate = new Date(data.bucket + ':00:00-08:00');
                      const hoursAgo = Math.floor((new Date() - bucketDate) / (1000 * 60 * 60));
                      if (!isNaN(hoursAgo) && hoursAgo >= 0) {
                        timeAgoText = ` <span style="color: #9CA3AF;">${hoursAgo} hour${hoursAgo !== 1 ? 's' : ''} ago</span>`;
                      }
                    } else {
                      // Daily - calculate days ago (bucket date is in PST)
                      const [year, month, day] = data.bucket.split('-').map(Number);
                      const bucketDate = new Date(year, month - 1, day, 12, 0, 0);
                      const now = new Date();
                      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                      const bucketStart = new Date(bucketDate.getFullYear(), bucketDate.getMonth(), bucketDate.getDate());
                      const daysAgo = Math.floor((todayStart - bucketStart) / (1000 * 60 * 60 * 24));
                      if (!isNaN(daysAgo) && daysAgo >= 0) {
                        if (daysAgo === 0) {
                          timeAgoText = ` <span style="color: #9CA3AF;">today</span>`;
                        } else if (daysAgo === 1) {
                          timeAgoText = ` <span style="color: #9CA3AF;">yesterday</span>`;
                        } else {
                          timeAgoText = ` <span style="color: #9CA3AF;">${daysAgo} days ago</span>`;
                        }
                      }
                    }

                    // Build HTML content with table for alignment
                    let innerHtml = `<div style="margin-bottom: 8px; display: flex; justify-content: space-between;"><span>${label}</span>${timeAgoText}</div>`;

                    // Gross Proceeds
                    const grossProceeds = data.newPurchases + data.renewals;

                    // Find each dataset in order
                    const newItem = items.find(item => item.dataset.label === 'New');
                    const renewalItem = items.find(item => item.dataset.label === 'Renewal');
                    const metaSpendItem = items.find(item => item.dataset.label === 'Meta Spend');
                    const tiktokSpendItem = items.find(item => item.dataset.label === 'TikTok Spend');
                    const appleSpendItem = items.find(item => item.dataset.label === 'Apple Spend');

                    // Net Profit
                    const netProfit = grossProceeds - data.spend;

                    const numColor = '#9AFCF1';
                    const netProfitColor = netProfit >= 0 ? '#4ADE80' : '#EF4444';

                    innerHtml += `<table style="border-collapse: collapse; width: 100%;">`;
                    innerHtml += `<tr style="margin-bottom: 6px;"><td>Gross Proceeds</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${grossProceeds.toFixed(2)}</td></tr>`;
                    if (newItem) {
                      innerHtml += `<tr><td><span style="color: #4ADE80;">●</span> New</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${newItem.raw.toFixed(2)}</td></tr>`;
                    }
                    if (renewalItem) {
                      innerHtml += `<tr><td><span style="color: #22D3D3;">●</span> Renewal</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${renewalItem.raw.toFixed(2)}</td></tr>`;
                    }
                    if (metaSpendItem || tiktokSpendItem || appleSpendItem) {
                      innerHtml += `<tr><td>Ad Spend</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${data.spend.toFixed(2)}</td></tr>`;
                    }
                    if (metaSpendItem && data.metaSpend > 0) {
                      innerHtml += `<tr><td><span style="color: #EF4444;">●</span> Meta</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${data.metaSpend.toFixed(2)}</td></tr>`;
                    }
                    if (tiktokSpendItem && data.tiktokSpend > 0) {
                      innerHtml += `<tr><td><span style="color: #F97316;">●</span> TikTok</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${data.tiktokSpend.toFixed(2)}</td></tr>`;
                    }
                    if (appleSpendItem && data.appleSpend > 0) {
                      innerHtml += `<tr><td><span style="color: #60A5FA;">●</span> Apple</td><td style="text-align: right; padding-left: 16px; color: ${numColor};">$${data.appleSpend.toFixed(2)}</td></tr>`;
                    }
                    innerHtml += `<tr style="margin-top: 6px;"><td>Net Profit</td><td style="text-align: right; padding-left: 16px; color: ${netProfitColor};">$${netProfit.toFixed(2)}</td></tr>`;
                    innerHtml += `</table>`;

                    tooltipEl.innerHTML = innerHtml;
                  }
                }

                const position = context.chart.canvas.getBoundingClientRect();

                // Display, position, and set styles for font
                tooltipEl.style.opacity = 1;

                // Use event position for mouse-following tooltip
                const eventX = tooltipModel.caretX;
                const eventY = tooltipModel.caretY;

                // Calculate initial position
                let left = position.left + window.pageXOffset + eventX;
                let top = position.top + window.pageYOffset + eventY - 60;

                // Get tooltip dimensions (need to temporarily display it to measure)
                tooltipEl.style.visibility = 'hidden';
                tooltipEl.style.display = 'block';
                const tooltipWidth = tooltipEl.offsetWidth;
                const tooltipHeight = tooltipEl.offsetHeight;
                tooltipEl.style.visibility = 'visible';

                // Check if tooltip would go off the right edge
                if (left + tooltipWidth > window.innerWidth + window.pageXOffset - 10) {
                  // Position to the left of the cursor instead
                  left = position.left + window.pageXOffset + eventX - tooltipWidth - 10;
                }

                // Check if tooltip would go off the left edge
                if (left < window.pageXOffset + 10) {
                  left = window.pageXOffset + 10;
                }

                // Check if tooltip would go off the top
                if (top < window.pageYOffset + 10) {
                  // Position below the cursor instead
                  top = position.top + window.pageYOffset + eventY + 10;
                }

                // Apply the calculated position
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
              },
            },
            annotation: {
              annotations: {
                incompleteHour: {
                  type: 'box',
                  xMin: processedData.length > 0 ? processedData.length - 1 : 0,
                  xMax: processedData.length > 0 ? processedData.length : 1,
                  backgroundColor: 'rgba(0, 0, 0, 0.2)',
                  borderWidth: 0,
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#666666',
                font: {
                  size: 11,
                },
                maxRotation: 0,
                minRotation: 0,
                autoSkip: true,
                maxTicksLimit: 12,
                callback: function(value, index) {
                  // Skip the first label to prevent overlap with y-axis
                  if (index === 0) return '';
                  return this.getLabelForValue(value);
                },
                display: true,
              },
              grid: {
                display: true,
                drawOnChartArea: false, // Only draw ticks, not grid lines
                drawTicks: true,
                tickLength: 5,
                tickColor: '#666666',
                drawBorder: true,
                borderColor: '#2A2D35',
              },
            },
            y: {
              ticks: {
                color: '#666666',
                font: {
                  size: 11,
                },
                callback: v => {
                  if (v >= 1000) {
                    // For values >= 1000, use K notation with 1 decimal for fractional values
                    const kValue = v / 1000;
                    if (kValue % 1 === 0) {
                      return '$' + kValue.toFixed(0) + 'K';
                    } else {
                      return '$' + kValue.toFixed(1) + 'K';
                    }
                  } else {
                    // For values < 1000, show the actual number
                    return '$' + v.toFixed(0);
                  }
                },
              },
              grid: {
                color: '#2A2D35',
                drawBorder: false,
              },
            },
          },
        },
      });

      // Hide tooltip when touching outside the chart on mobile
      document.addEventListener('touchstart', function(e) {
        const chartCanvas = document.getElementById('chart');
        const tooltipEl = document.getElementById('chartjs-tooltip');
        if (tooltipEl && !chartCanvas.contains(e.target)) {
          tooltipEl.style.opacity = 0;
        }
      }, { passive: true });
    }

    function updateTable() {
      const headerRow = document.getElementById('table-header');
      const newRow = document.getElementById('new-row');
      const renewalRow = document.getElementById('renewal-row');
      const metaSpendRow = document.getElementById('meta-spend-row');
      const tiktokSpendRow = document.getElementById('tiktok-spend-row');
      const appleSpendRow = document.getElementById('apple-spend-row');
      const netProfitRow = document.getElementById('net-profit-row');

      // Clear existing data cells (keep first sticky column)
      while (headerRow.children.length > 1) headerRow.removeChild(headerRow.lastChild);
      while (newRow.children.length > 1) newRow.removeChild(newRow.lastChild);
      while (renewalRow.children.length > 1) renewalRow.removeChild(renewalRow.lastChild);
      while (metaSpendRow.children.length > 1) metaSpendRow.removeChild(metaSpendRow.lastChild);
      while (tiktokSpendRow.children.length > 1) tiktokSpendRow.removeChild(tiktokSpendRow.lastChild);
      while (appleSpendRow.children.length > 1) appleSpendRow.removeChild(appleSpendRow.lastChild);
      while (netProfitRow.children.length > 1) netProfitRow.removeChild(netProfitRow.lastChild);

      // Add data columns for each time period
      // Bucket keys are in PST after the -8 hour correction
      const displayTimezone = document.getElementById('timezone').value;

      processedData.forEach(row => {
        // Header - format date
        const th = document.createElement('th');

        if (granularity === 'daily') {
          // Daily bucket like "2025-12-21" is a PST date - just display the date
          const [year, month, day] = row.bucket.split('-').map(Number);
          const date = new Date(year, month - 1, day, 12, 0, 0);
          th.textContent = date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
          });
        } else {
          // Hourly bucket like "2025-12-21T20" is 8pm PST
          const pstDate = new Date(row.bucket + ':00:00-08:00');
          const weekday = pstDate.toLocaleDateString('en-US', {
            timeZone: displayTimezone,
            weekday: 'short'
          });
          const time = pstDate.toLocaleTimeString('en-US', {
            timeZone: displayTimezone,
            hour: 'numeric'
          }).toLowerCase();
          th.textContent = `${weekday}, ${time}`;
        }
        headerRow.appendChild(th);

        // New
        const newTd = document.createElement('td');
        newTd.textContent = '$' + row.newPurchases.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        newTd.style.color = 'white';
        newRow.appendChild(newTd);

        // Renewal
        const renewalTd = document.createElement('td');
        renewalTd.textContent = '$' + row.renewals.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        renewalTd.style.color = 'white';
        renewalRow.appendChild(renewalTd);

        // Meta Spend
        const metaSpendTd = document.createElement('td');
        metaSpendTd.textContent = '$' + row.metaSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        metaSpendTd.style.color = 'white';
        metaSpendRow.appendChild(metaSpendTd);

        // TikTok Spend
        const tiktokSpendTd = document.createElement('td');
        tiktokSpendTd.textContent = '$' + row.tiktokSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        tiktokSpendTd.style.color = 'white';
        tiktokSpendRow.appendChild(tiktokSpendTd);

        // Apple Spend
        const appleSpendTd = document.createElement('td');
        appleSpendTd.textContent = '$' + row.appleSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        appleSpendTd.style.color = 'white';
        appleSpendRow.appendChild(appleSpendTd);

        // Net Profit
        const netProfit = row.newPurchases + row.renewals - row.spend;
        const netProfitTd = document.createElement('td');
        netProfitTd.textContent = '$' + netProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        netProfitTd.style.color = netProfit >= 0 ? '#4ADE80' : '#EF4444';
        netProfitRow.appendChild(netProfitTd);
      });

      // Add total column
      const totals = processedData.reduce((acc, d) => ({
        newPurchases: acc.newPurchases + d.newPurchases,
        renewals: acc.renewals + d.renewals,
        spend: acc.spend + d.spend,
        metaSpend: acc.metaSpend + d.metaSpend,
        tiktokSpend: acc.tiktokSpend + d.tiktokSpend,
        appleSpend: acc.appleSpend + d.appleSpend,
      }), { newPurchases: 0, renewals: 0, spend: 0, metaSpend: 0, tiktokSpend: 0, appleSpend: 0 });

      // Total header
      const totalTh = document.createElement('th');
      totalTh.textContent = 'Total';
      totalTh.style.color = '#9CA3AF';
      headerRow.appendChild(totalTh);

      // Total new
      const totalNewTd = document.createElement('td');
      totalNewTd.textContent = '$' + totals.newPurchases.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalNewTd.style.color = 'white';
      totalNewTd.style.fontWeight = '600';
      newRow.appendChild(totalNewTd);

      // Total renewal
      const totalRenewalTd = document.createElement('td');
      totalRenewalTd.textContent = '$' + totals.renewals.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalRenewalTd.style.color = 'white';
      totalRenewalTd.style.fontWeight = '600';
      renewalRow.appendChild(totalRenewalTd);

      // Total Meta spend
      const totalMetaSpendTd = document.createElement('td');
      totalMetaSpendTd.textContent = '$' + totals.metaSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalMetaSpendTd.style.color = 'white';
      totalMetaSpendTd.style.fontWeight = '600';
      metaSpendRow.appendChild(totalMetaSpendTd);

      // Total TikTok spend
      const totalTikTokSpendTd = document.createElement('td');
      totalTikTokSpendTd.textContent = '$' + totals.tiktokSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalTikTokSpendTd.style.color = 'white';
      totalTikTokSpendTd.style.fontWeight = '600';
      tiktokSpendRow.appendChild(totalTikTokSpendTd);

      // Total Apple spend
      const totalAppleSpendTd = document.createElement('td');
      totalAppleSpendTd.textContent = '$' + totals.appleSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalAppleSpendTd.style.color = 'white';
      totalAppleSpendTd.style.fontWeight = '600';
      appleSpendRow.appendChild(totalAppleSpendTd);

      // Total net profit
      const totalNetProfit = totals.newPurchases + totals.renewals - totals.spend;
      const totalNetProfitTd = document.createElement('td');
      totalNetProfitTd.textContent = '$' + totalNetProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalNetProfitTd.style.color = totalNetProfit >= 0 ? '#4ADE80' : '#EF4444';
      totalNetProfitTd.style.fontWeight = '600';
      netProfitRow.appendChild(totalNetProfitTd);

      // Scroll table to the right to show most recent data and totals
      const tableContainer = document.querySelector('.chart-container[style*="overflow-x"]');
      if (tableContainer) {
        setTimeout(() => {
          tableContainer.scrollLeft = tableContainer.scrollWidth;
        }, 0);
      }
    }

    function updateTransactions() {
      const tbody = document.getElementById('transactions-tbody');
      tbody.innerHTML = '';

      // transactionsData is already sorted by created_at desc from the API
      const sortedTransactions = transactionsData;

      // Determine how many to show (initial 16, max 50)
      const initialShow = 16;
      const maxShow = 50;
      const limit = showAllTransactions ? Math.min(sortedTransactions.length, maxShow) : initialShow;
      const transactionsToShow = sortedTransactions.slice(0, limit);
      const remainingCount = Math.max(0, Math.min(sortedTransactions.length, maxShow) - initialShow);

      // Update the "Show more" button
      const showMoreContainer = document.getElementById('show-more-container');
      const moreText = document.getElementById('more-text');

      if (remainingCount > 0 && !showAllTransactions) {
        showMoreContainer.style.display = 'block';
        moreText.textContent = `Show ${remainingCount} more`;
      } else if (showAllTransactions && sortedTransactions.length > initialShow) {
        showMoreContainer.style.display = 'block';
        moreText.textContent = 'Show less';
        document.querySelector('#show-more-btn span:last-child').textContent = '↑';
      } else {
        showMoreContainer.style.display = 'none';
      }

      // Add rows
      transactionsToShow.forEach((transaction, index) => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #2D3748';

        // Parse raw payload for extra data
        let parsedPayload = null;
        let countryCode = 'US';
        let appUserId = null;
        let productIdFromPayload = null;

        try {
          if (transaction.raw_payload) {
            // Check if raw_payload is already an object or needs parsing
            if (typeof transaction.raw_payload === 'string') {
              parsedPayload = JSON.parse(transaction.raw_payload);
            } else {
              parsedPayload = transaction.raw_payload;
            }

            if (parsedPayload && parsedPayload.data) {
              // Get country code
              countryCode = parsedPayload.data.countryCode || 'US';

              // Get productId from data
              productIdFromPayload = parsedPayload.data.productId;

              // Get appUserId from userAttributes
              if (parsedPayload.data.userAttributes) {
                appUserId = parsedPayload.data.userAttributes.appUserId;
              }
            }
          }
        } catch (e) {
          // Silently handle errors
        }

        // Use appUserId from payload, fallback to user_id from transaction
        let userId = appUserId || transaction.user_id || '';
        let productId = productIdFromPayload || transaction.product_id || '';

        // Get country flag
        const getCountryFlag = (code) => {
          const flags = {
            'US': '🇺🇸',
            'GB': '🇬🇧',
            'CA': '🇨🇦',
            'AU': '🇦🇺',
            'NZ': '🇳🇿',
            'IE': '🇮🇪',
            'DE': '🇩🇪',
            'FR': '🇫🇷',
            'IT': '🇮🇹',
            'ES': '🇪🇸',
            'PT': '🇵🇹',
            'NL': '🇳🇱',
            'BE': '🇧🇪',
            'CH': '🇨🇭',
            'AT': '🇦🇹',
            'SE': '🇸🇪',
            'NO': '🇳🇴',
            'DK': '🇩🇰',
            'FI': '🇫🇮',
            'PL': '🇵🇱',
            'RU': '🇷🇺',
            'UA': '🇺🇦',
            'JP': '🇯🇵',
            'KR': '🇰🇷',
            'CN': '🇨🇳',
            'IN': '🇮🇳',
            'SG': '🇸🇬',
            'MY': '🇲🇾',
            'TH': '🇹🇭',
            'ID': '🇮🇩',
            'PH': '🇵🇭',
            'VN': '🇻🇳',
            'BR': '🇧🇷',
            'MX': '🇲🇽',
            'AR': '🇦🇷',
            'CO': '🇨🇴',
            'CL': '🇨🇱',
            'PE': '🇵🇪',
            'ZA': '🇿🇦',
            'EG': '🇪🇬',
            'TR': '🇹🇷',
            'IL': '🇮🇱',
            'SA': '🇸🇦',
            'AE': '🇦🇪'
          };
          return flags[code] || '🏳️';
        };

        // Format user ID - truncate for display
        const formatUserId = () => {
          if (userId) {
            // For UUIDs like D77162D1-57D0-4CC5-8FBE-680DC6BF7A5C
            // Show first 6 and last 6 characters
            if (userId.length > 12) {
              return userId.substring(0, 6).toUpperCase() + '...' + userId.substring(userId.length - 6).toUpperCase();
            }
            return userId.toUpperCase();
          }
          return '—';
        };

        // Format product name
        const formatProductName = (pid) => {
          if (!pid) return '—';
          const cleaned = APP.productPrefix ? pid.replace(new RegExp(`^${APP.productPrefix}`), '') : pid;

          // Check app-specific product map
          if (APP.productMap[cleaned]) {
            return APP.productMap[cleaned];
          }

          // Fallback patterns
          if (cleaned.includes('_1y')) {
            const price = cleaned.replace('_1y', '');
            return `$${(parseInt(price) / 100).toFixed(2)}/yr`;
          }
          if (cleaned.includes('_1w')) {
            const price = cleaned.replace('_1w', '');
            return `$${(parseInt(price) / 100).toFixed(2)}/wk`;
          }

          return cleaned;
        };

        // Format time
        const formatTime = (dateStr) => {
          const date = new Date(dateStr);
          const timezone = document.getElementById('timezone').value;
          return date.toLocaleTimeString('en-US', {
            timeZone: timezone,
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          }).toLowerCase().replace(' ', '');
        };

        // Format type
        const getTypeDisplay = (eventType, isRefund) => {
          if (isRefund) {
            return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #2D3748; padding: 4px 12px; border-radius: 16px; color: #EF4444; font-weight: 500;">🔴 Refund</span>`;
          }
          switch(eventType) {
            case 'initial_purchase':
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #1F3A2E; padding: 4px 12px; border-radius: 16px; color: #4ADE80; font-weight: 500;">🍎 Direct Sub Start</span>`;
            case 'renewal':
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #2D3748; padding: 4px 12px; border-radius: 16px; color: #9CA3AF; font-weight: 500;">🔄 Renewal</span>`;
            case 'cancellation':
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #3A2A1F; padding: 4px 12px; border-radius: 16px; color: #F59E0B; font-weight: 500;">🟠 Sub Cancel</span>`;
            default:
              return `<span style="display: inline-flex; align-items: center; gap: 6px; background: #2D3748; padding: 4px 12px; border-radius: 16px; color: #9CA3AF; font-weight: 500;">⚪ ${eventType}</span>`;
          }
        };

        const typeDisplay = getTypeDisplay(transaction.event_type, transaction.is_refund);

        // User cell
        const userTd = document.createElement('td');
        userTd.style.padding = '6px';
        userTd.style.color = 'white';
        userTd.style.fontSize = '0.8125rem';
        const flag = getCountryFlag(countryCode);
        userTd.innerHTML = `<span style="margin-right: 6px;">${flag}</span><span>${formatUserId()}</span>`;
        tr.appendChild(userTd);

        // Product cell
        const productTd = document.createElement('td');
        productTd.style.padding = '6px';
        productTd.style.color = 'white';
        productTd.style.fontSize = '0.8125rem';
        productTd.textContent = formatProductName(productId);
        tr.appendChild(productTd);

        // Revenue cell
        const revenueTd = document.createElement('td');
        revenueTd.style.padding = '6px';
        revenueTd.style.color = 'white';
        revenueTd.style.fontSize = '0.8125rem';
        const proceeds = parseFloat(transaction.proceeds) || 0;
        revenueTd.textContent = proceeds > 0 ? '$' + proceeds.toFixed(2) : '—';
        tr.appendChild(revenueTd);

        // When cell
        const whenTd = document.createElement('td');
        whenTd.style.padding = '6px';
        whenTd.style.color = '#9CA3AF';
        whenTd.style.fontSize = '0.8125rem';
        whenTd.textContent = formatTime(transaction.created_at);
        tr.appendChild(whenTd);

        // Type cell
        const typeTd = document.createElement('td');
        typeTd.style.padding = '6px';
        typeTd.style.fontSize = '0.8125rem';
        typeTd.innerHTML = typeDisplay;
        tr.appendChild(typeTd);

        tbody.appendChild(tr);
      });

      // If no transactions
      if (transactionsToShow.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.style.padding = '24px';
        td.style.textAlign = 'center';
        td.style.color = '#6B7280';
        td.textContent = 'No transactions found';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function toggleShowMore() {
      showAllTransactions = !showAllTransactions;
      updateTransactions();
    }

    // Initialize on load
    initAppBranding();
    checkAuth();
  </script>
</body>
</html>